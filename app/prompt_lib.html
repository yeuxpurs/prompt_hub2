<!DOCTYPE html>
<html lang="ja" data-current-lang="ja">
<head>
  <meta charset="UTF-8">
  <title data-i18n="appTitle">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f5f6fa; }
    .sidebar   { min-width:350px; max-width:420px; background:#fff; border-radius:18px; padding:24px; margin:22px 0 22px 28px; box-shadow:0 3px 15px rgba(0,0,0,.08);}
    .main-pane { background:#fff; border-radius:18px; margin:22px 28px 22px 0; padding:32px 32px 42px 32px; box-shadow:0 3px 15px rgba(0,0,0,.08);}
    .cat-block { margin-bottom:30px; border:1.5px solid #eee; border-radius:13px; background:#fafbfc; transition: all 0.2s ease; }
    .cat-header{ display:flex; align-items:center; gap:10px; font-size:1.18em; font-weight:700; padding:16px 22px 0 18px; cursor:pointer;}
    .cat-title { color:#1567c6; letter-spacing:-0.3px;}
    .cat-actions button{ margin-left:7px; }
    .task-list { padding:7px 14px 13px 18px; }
    .task-item { display:flex; align-items:center; border-radius:7px; margin-bottom:8px; padding:7px 8px 7px 11px; background:#fff; border:1px solid #eee; cursor: move;}
    .task-name { flex:1; font-size:1.07em; color:#212b36; cursor:pointer;}
    .task-actions button{ margin-left:5px; }
    .btn-add   { background:#15c645; color:#fff; }
    .btn-edit  { background:#ffc107; color:#000;}
    .btn-del   { background:#dc3545; color:#fff;}

    /* â–¼ ë“œë˜ê·¸ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .dragging { opacity: 0.5; transform: scale(0.95); z-index: 1000; }
    .drag-over { border: 2px dashed #007bff !important; background: #e3f2fd !important; }
    .cat-block.drag-over { transform: translateY(-2px); }
    .task-item.drag-over { border-color: #28a745 !important; }
    .prompt-box.drag-over { border-color: #17a2b8 !important; }

    .drag-handle { color: #666; font-size: 1.2em; cursor: grab; padding: 0 8px; margin-left: -8px; }
    .drag-handle:hover { color: #333; }
    .drag-handle:active { cursor: grabbing; }
    .task-drag-handle { color: #666; font-size: 1em; cursor: grab; padding: 0 6px; margin-left: -6px; }
    .task-drag-handle:hover { color: #333; }
    .task-drag-handle:active { cursor: grabbing; }
    .prompt-drag-handle { color: #666; font-size: 1.1em; cursor: grab; padding: 4px 8px; position: absolute; left: 12px; top: 35px; z-index: 10; }
    .prompt-drag-handle:hover { color: #333; }
    .prompt-drag-handle:active { cursor: grabbing; }

    /* â–¼ ì„ íƒ êµ¬ìš© ì²´í¬ë°•ìŠ¤ ë°°ì¹˜ (ë“œë˜ê·¸ í•¸ë“¤ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì¡°ì •) */
    .prompt-select { position:absolute; left:12px; top:10px; transform:scale(1.15); }
    .prompt-box    { background:#f5faff; border:1.3px solid #dde3eb; border-radius:8px; padding:18px 14px 14px 45px; margin-bottom:16px; position:relative; cursor: move;}
    .prompt-actions button{ margin-right:7px; }
    .prompt-actions{ position:absolute; right:18px; top:10px;}
    .form-control{ font-size:1.08em;}
    .btn-prompt-add{ margin-left:auto; }
    
    /* â–¼ ë¬¸ìí¬ê¸° ì¡°ì •ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .font-size-controls { display: flex; gap: 5px; margin-bottom: 15px; align-items: center; }
    .font-size-btn { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }
    .font-size-btn:hover { background: #e9ecef; }
    .font-size-btn.active { background: #007bff; color: white; border-color: #007bff; }
    
    /* ë¬¸ìí¬ê¸° í´ë˜ìŠ¤ */
    .font-size-small { font-size: 0.85em !important; }
    .font-size-small .form-control, .font-size-small pre, .font-size-small .task-name, .font-size-small .cat-title { font-size: 0.95em !important; }
    .font-size-medium { font-size: 1em !important; }
    .font-size-medium .form-control, .font-size-medium pre, .font-size-medium .task-name, .font-size-medium .cat-title { font-size: 1.07em !important; }
    .font-size-large { font-size: 1.15em !important; }
    .font-size-large .form-control, .font-size-large pre, .font-size-large .task-name, .font-size-large .cat-title { font-size: 1.25em !important; }
    .font-size-xlarge { font-size: 1.3em !important; }
    .font-size-xlarge .form-control, .font-size-xlarge pre, .font-size-xlarge .task-name, .font-size-xlarge .cat-title { font-size: 1.4em !important; }
    
    /* â–¼ í”„ë¡¬í”„íŠ¸ ì ‘ê¸°ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .prompt-text { margin-bottom: 0; font-size: 1.06em; white-space: pre-wrap; word-wrap: break-word; }
    .prompt-text.collapsed { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; white-space: pre-wrap; }
    .toggle-btn { background: none; border: none; color: #007bff; font-size: 0.9em; padding: 4px 0; margin-top: 8px; cursor: pointer; text-decoration: underline; }
    .toggle-btn:hover { color: #0056b3; }

    /* â–¼ ì„í¬íŠ¸ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .import-area { border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; background: #f8f9fa; transition: all 0.3s ease; }
    .import-area.dragover { border-color: #007bff; background: #e3f2fd; }
    .file-input-hidden { display: none; }
    .status-message { margin-top: 10px; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; }
    .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    /* ì–¸ì–´ì„ íƒë°” ìŠ¤íƒ€ì¼ */
    #langBar { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #eee; }
    
    @media (max-width:900px){
      .sidebar, .main-pane{ margin:10px; padding:12px; }
      .main-pane{ padding-top:17px;}
    }
  </style>
</head>
<body>

  <!-- â–¸â–¸ ê¸€ë¡œë²Œ ì–¸ì–´ì„ íƒë°” â—‚â—‚ -->
  <div class="d-flex justify-content-end align-items-center p-2" id="langBar">
    <div class="btn-group">
      <button id="langBtn" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        ğŸŒ <span id="langBtnLabel">æ—¥æœ¬èª</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="#" data-lang="ja">æ—¥æœ¬èª</a></li>
        <li><a class="dropdown-item" href="#" data-lang="en">English</a></li>
        <li><a class="dropdown-item" href="#" data-lang="zh">ç®€ä½“ä¸­æ–‡</a></li>
        <li><a class="dropdown-item" href="#" data-lang="ko">í•œêµ­ì–´</a></li>
        <li><a class="dropdown-item" href="#" data-lang="fr">FranÃ§ais</a></li>
        <li><a class="dropdown-item" href="#" data-lang="es">EspaÃ±ol</a></li>
      </ul>
    </div>
  </div>

  <div class="d-flex flex-row" style="gap:32px;">
    <!-- â–¸â–¸ ì‚¬ì´ë“œë°” â—‚â—‚ -->
    <div class="sidebar">
      <h2 class="mb-3" style="font-weight:800; font-size:1.37em;">
        <span style="font-size:1.21em; margin-right:8px;">ğŸ“š</span>
        <span data-i18n="appTitle">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª</span>
      </h2>

      <!-- ë¬¸ìí¬ê¸° ì¡°ì • -->
      <div class="font-size-controls">
        <span data-i18n="fontSizeLabel" style="font-size: 0.9em; color: #666; margin-right: 8px;">æ–‡å­—ã‚µã‚¤ã‚º:</span>
        <div class="font-size-btn" data-size="small" onclick="setFontSize('small')" title="å°">A</div>
        <div class="font-size-btn active" data-size="medium" onclick="setFontSize('medium')" title="æ¨™æº–">A</div>
        <div class="font-size-btn" data-size="large" onclick="setFontSize('large')" title="å¤§" style="font-size: 1.1em;">A</div>
        <div class="font-size-btn" data-size="xlarge" onclick="setFontSize('xlarge')" title="ç‰¹å¤§" style="font-size: 1.2em;">A</div>
      </div>

      <!-- ìµìŠ¤í¬íŠ¸/ì„í¬íŠ¸ ë²„íŠ¼ -->
      <div class="d-grid gap-2 mb-3">
        <button class="btn btn-outline-secondary" onclick="exportData()" data-i18n="exportBtn">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="btn btn-outline-secondary" onclick="toggleImportArea()" data-i18n="importBtn">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      </div>

      <!-- ì„í¬íŠ¸ì˜ì—­ï¼ˆí‘œì‹œ/ë¹„í‘œì‹œ í† ê¸€ï¼‰ -->
      <div id="importArea" class="import-area" style="display: none;">
        <div class="mb-2">
          <strong data-i18n="importTitle">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</strong>
        </div>
        <div class="mb-2" style="font-size: 0.9em; color: #666;" data-i18n="importInstructions">
          JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã‹ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„
        </div>
        <input type="file" id="fileInput" class="file-input-hidden" accept=".json" onchange="handleFileSelect(event)">
        <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('fileInput').click()" data-i18n="fileSelect">
          ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        </button>
        <div class="mt-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="toggleImportArea()" data-i18n="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div id="statusMessage"></div>
      </div>

      <button class="btn btn-primary w-100 mb-3" onclick="openCategoryModal()" data-i18n="addCategory">ï¼‹ æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </button>
      <div id="cat-container"></div>
    </div>

    <!-- â–¸â–¸ ë©”ì¸ìƒì„¸ â—‚â—‚ -->
    <div class="main-pane flex-fill">
      <div id="detail-area" style="min-height:380px;">
        <div class="text-center text-secondary" style="padding:90px 0 70px 0; font-size:1.3em;" data-i18n="noSelection">
          å·¦å´ã‹ã‚‰é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>ã‚¿ã‚¹ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- â–¸â–¸ ê³µí†µëª¨ë‹¬ â—‚â—‚ -->
  <div class="modal" tabindex="-1" id="editModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 id="modalTitle" class="modal-title"></h5></div>
        <div class="modal-body">
          <div id="emojiInputRow" style="display:none;">
            <label for="modalEmoji" class="form-label mb-1" data-i18n="emojiLabel">çµµæ–‡å­—</label>
            <input type="text" id="modalEmoji" class="form-control mb-2" placeholder="ä¾‹: ğŸ“" maxlength="2" style="width:90px; display:inline-block;">
          </div>
          <input type="text" id="modalInput" class="form-control mb-2" placeholder="">
          <textarea id="modalTextarea" class="form-control" rows="8" style="display:none; resize: both; min-height: 200px; min-width: 300px;"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()" data-i18n="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-primary" onclick="saveModal()" data-i18n="saveBtn">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬ ---------- */
let data; // ë°ì´í„° ê°ì²´
let currentCat = null, currentTask = null; // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ë° íƒœìŠ¤í¬ ID
let modalMode = null, modalRefObj = null, modalType = null; // ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜
let catToggleState; // ì¹´í…Œê³ ë¦¬ ì ‘ê¸°/í´ê¸° ìƒíƒœ
let currentFontSize; // í˜„ì¬ ê¸€ê¼´ í¬ê¸°
let selectedPrompt = null; // {cat, task, idx} ë˜ëŠ” null
let currentLang = 'ja'; // í˜„ì¬ ì–¸ì–´
let draggedElement = null, dragType = null, dragContext = null; // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ ë³€ìˆ˜

/* ---------- ë‹¤êµ­ì–´ ë¦¬ì†ŒìŠ¤ ---------- */
const translations = {
  ja: {
    langName: "æ—¥æœ¬èª",
    appTitle: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª",
    fontSizeLabel: "æ–‡å­—ã‚µã‚¤ã‚º:",
    exportBtn: "ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
    importBtn: "ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
    importTitle: "ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
    importInstructions: "JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã‹ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„",
    fileSelect: "ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ",
    cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
    addCategory: "ï¼‹ æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ",
    noSelection: "å·¦å´ã‹ã‚‰é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>ã‚¿ã‚¹ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚",
    emojiLabel: "çµµæ–‡å­—",
    saveBtn: "ä¿å­˜",
    taskContentPlaceholder: "ã‚¿ã‚¹ã‚¯é–¢é€£ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...",
    taskContentHint: "â€» å†…å®¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã™ãã«åæ˜ ã•ã‚Œã¾ã™ã€‚<b>Ctrl+V</b>ã§è²¼ã‚Šä»˜ã‘ã‚‚å¯èƒ½ã§ã™ï¼",
    completedPrompt: "2. å®Œæˆã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ",
    addPrompt: "ï¼‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¿½åŠ ",
    copy: "ğŸ“‹ ã‚³ãƒ”ãƒ¼",
    edit: "ç·¨é›†",
    delete: "å‰Šé™¤",
    copyComplete: "âœ… ã‚³ãƒ”ãƒ¼å®Œäº†",
    showMore: "ã‚‚ã£ã¨è¦‹ã‚‹ â–¼",
    showLess: "æŠ˜ã‚ŠãŸãŸã‚€ â–²",
    noSelectedPrompt: "é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
    categoryAdd: "ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ",
    categoryEdit: "ã‚«ãƒ†ã‚´ãƒªç·¨é›†",
    taskAdd: "ã‚¿ã‚¹ã‚¯è¿½åŠ ",
    taskEdit: "ã‚¿ã‚¹ã‚¯ç·¨é›†",
    promptAdd: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¿½åŠ ",
    promptEdit: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†",
    enterCategoryName: "ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼",
    enterTaskName: "ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼",
    enterPromptContent: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼",
    confirmDeleteCategory: "ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
    confirmDeleteTask: "ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
    confirmDeletePrompt: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
    copyFailed: "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼",
    jsonOnly: "JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚",
    fileReading: "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...",
    invalidFile: "æ­£ã—ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚",
    emptyCategoryData: "ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ç©ºã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§é–‹å§‹ã—ã¾ã™ã€‚",
    importComplete: "ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼{0}å€‹ã®ã‚«ãƒ†ã‚´ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™ã€‚",
    importFailed: "ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: {0}",
    fileReadError: "ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚",
    exportComplete: "ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†: {0}",
    exportFailed: "âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—: {0}"
  },
  en: {
    langName: "English",
    appTitle: "Prompt Library",
    fontSizeLabel: "Font Size:",
    exportBtn: "ğŸ“¤ Export",
    importBtn: "ğŸ“¥ Import",
    importTitle: "ğŸ“¥ Import File",
    importInstructions: "Drag & drop a JSON file or click to select",
    fileSelect: "Select File",
    cancel: "Cancel",
    addCategory: "+ Add New Category",
    noSelection: "Please select an item from the left.<br>Click a task to see the detailed prompts.",
    emojiLabel: "Emoji",
    saveBtn: "Save",
    taskContentPlaceholder: "Enter task-related content here...",
    taskContentHint: "â€» Content entered here will be immediately reflected in the prompts below. You can also paste with <b>Ctrl+V</b>!",
    completedPrompt: "2. Completed Prompt",
    addPrompt: "+ Add Prompt",
    copy: "ğŸ“‹ Copy",
    edit: "Edit",
    delete: "Delete",
    copyComplete: "âœ… Copied!",
    showMore: "Show More â–¼",
    showLess: "Show Less â–²",
    noSelectedPrompt: "No prompt selected.",
    categoryAdd: "Add Category",
    categoryEdit: "Edit Category",
    taskAdd: "Add Task",
    taskEdit: "Edit Task",
    promptAdd: "Add Prompt",
    promptEdit: "Edit Prompt",
    enterCategoryName: "Please enter a category name!",
    enterTaskName: "Please enter a task name!",
    enterPromptContent: "Please enter the prompt content!",
    confirmDeleteCategory: "Are you sure you want to delete this category?",
    confirmDeleteTask: "Are you sure you want to delete this task?",
    confirmDeletePrompt: "Are you sure you want to delete this prompt?",
    copyFailed: "Failed to copy!",
    jsonOnly: "Only JSON files are supported.",
    fileReading: "Reading file...",
    invalidFile: "This is not a valid prompt library file. Data not found.",
    emptyCategoryData: "No category data found, starting with an empty library.",
    importComplete: "Import complete! Imported {0} categories. The page will now refresh.",
    importFailed: "Import failed: {0}",
    fileReadError: "An error occurred while reading the file.",
    exportComplete: "ğŸ“¤ Export complete: {0}",
    exportFailed: "âŒ Export failed: {0}"
  },
  zh: {
    langName: "ç®€ä½“ä¸­æ–‡",
    appTitle: "æç¤ºè¯åº“",
    fontSizeLabel: "å­—ä½“å¤§å°:",
    exportBtn: "ğŸ“¤ å¯¼å‡º",
    importBtn: "ğŸ“¥ å¯¼å…¥",
    importTitle: "ğŸ“¥ å¯¼å…¥æ–‡ä»¶",
    importInstructions: "æ‹–æ”¾JSONæ–‡ä»¶æˆ–ç‚¹å‡»é€‰æ‹©",
    fileSelect: "é€‰æ‹©æ–‡ä»¶",
    cancel: "å–æ¶ˆ",
    addCategory: "ï¼‹ æ·»åŠ æ–°åˆ†ç±»",
    noSelection: "è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªé¡¹ç›®ã€‚<br>ç‚¹å‡»ä»»åŠ¡ä»¥æŸ¥çœ‹è¯¦ç»†æç¤ºã€‚",
    emojiLabel: "è¡¨æƒ…ç¬¦å·",
    saveBtn: "ä¿å­˜",
    taskContentPlaceholder: "åœ¨æ­¤è¾“å…¥ä»»åŠ¡ç›¸å…³å†…å®¹...",
    taskContentHint: "â€» è¾“å…¥çš„å†…å®¹å°†ç«‹å³åæ˜ åœ¨ä¸‹é¢çš„æç¤ºä¸­ã€‚æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ <b>Ctrl+V</b> ç²˜è´´ï¼",
    completedPrompt: "2. å®Œæˆçš„æç¤º",
    addPrompt: "ï¼‹ æ·»åŠ æç¤º",
    copy: "ğŸ“‹ å¤åˆ¶",
    edit: "ç¼–è¾‘",
    delete: "åˆ é™¤",
    copyComplete: "âœ… å·²å¤åˆ¶",
    showMore: "æ˜¾ç¤ºæ›´å¤š â–¼",
    showLess: "æ”¶èµ· â–²",
    noSelectedPrompt: "æœªé€‰æ‹©ä»»ä½•æç¤ºã€‚",
    categoryAdd: "æ·»åŠ åˆ†ç±»",
    categoryEdit: "ç¼–è¾‘åˆ†ç±»",
    taskAdd: "æ·»åŠ ä»»åŠ¡",
    taskEdit: "ç¼–è¾‘ä»»åŠ¡",
    promptAdd: "æ·»åŠ æç¤º",
    promptEdit: "ç¼–è¾‘æç¤º",
    enterCategoryName: "è¯·è¾“å…¥åˆ†ç±»åç§°ï¼",
    enterTaskName: "è¯·è¾“å…¥ä»»åŠ¡åç§°ï¼",
    enterPromptContent: "è¯·è¾“å…¥æç¤ºå†…å®¹ï¼",
    confirmDeleteCategory: "ç¡®å®šè¦åˆ é™¤æ­¤åˆ†ç±»å—ï¼Ÿ",
    confirmDeleteTask: "ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ",
    confirmDeletePrompt: "ç¡®å®šè¦åˆ é™¤æ­¤æç¤ºå—ï¼Ÿ",
    copyFailed: "å¤åˆ¶å¤±è´¥ï¼",
    jsonOnly: "ä»…æ”¯æŒJSONæ–‡ä»¶ã€‚",
    fileReading: "æ­£åœ¨è¯»å–æ–‡ä»¶...",
    invalidFile: "ä¸æ˜¯æœ‰æ•ˆçš„æç¤ºåº“æ–‡ä»¶ã€‚æœªæ‰¾åˆ°æ•°æ®ã€‚",
    emptyCategoryData: "æœªæ‰¾åˆ°åˆ†ç±»æ•°æ®ï¼Œå°†ä»¥ç©ºåº“å¼€å§‹ã€‚",
    importComplete: "å¯¼å…¥å®Œæˆï¼å·²å¯¼å…¥ {0} ä¸ªåˆ†ç±»ã€‚é¡µé¢å³å°†åˆ·æ–°ã€‚",
    importFailed: "å¯¼å…¥å¤±è´¥ï¼š{0}",
    fileReadError: "è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ã€‚",
    exportComplete: "ğŸ“¤ å¯¼å‡ºå®Œæˆ: {0}",
    exportFailed: "âŒ å¯¼å‡ºå¤±è´¥: {0}"
  },
  ko: {
    langName: "í•œêµ­ì–´",
    appTitle: "í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬",
    fontSizeLabel: "ê¸€ê¼´ í¬ê¸°:",
    exportBtn: "ğŸ“¤ ë‚´ë³´ë‚´ê¸°",
    importBtn: "ğŸ“¥ ê°€ì ¸ì˜¤ê¸°",
    importTitle: "ğŸ“¥ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°",
    importInstructions: "JSON íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”",
    fileSelect: "íŒŒì¼ ì„ íƒ",
    cancel: "ì·¨ì†Œ",
    addCategory: "ï¼‹ ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€",
    noSelection: "ì™¼ìª½ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.<br>íƒœìŠ¤í¬ë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ í”„ë¡¬í”„íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.",
    emojiLabel: "ì´ëª¨ì§€",
    saveBtn: "ì €ì¥",
    taskContentPlaceholder: "íƒœìŠ¤í¬ ê´€ë ¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",
    taskContentHint: "â€» ë‚´ìš©ì„ ì…ë ¥í•˜ë©´ ì•„ë˜ í”„ë¡¬í”„íŠ¸ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤. <b>Ctrl+V</b>ë¡œ ë¶™ì—¬ë„£ê¸°ë„ ê°€ëŠ¥í•´ìš”!",
    completedPrompt: "2. ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸",
    addPrompt: "ï¼‹ í”„ë¡¬í”„íŠ¸ ì¶”ê°€",
    copy: "ğŸ“‹ ë³µì‚¬",
    edit: "í¸ì§‘",
    delete: "ì‚­ì œ",
    copyComplete: "âœ… ë³µì‚¬ ì™„ë£Œ",
    showMore: "ë” ë³´ê¸° â–¼",
    showLess: "ì ‘ê¸° â–²",
    noSelectedPrompt: "ì„ íƒëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.",
    categoryAdd: "ì¹´í…Œê³ ë¦¬ ì¶”ê°€",
    categoryEdit: "ì¹´í…Œê³ ë¦¬ í¸ì§‘",
    taskAdd: "íƒœìŠ¤í¬ ì¶”ê°€",
    taskEdit: "íƒœìŠ¤í¬ í¸ì§‘",
    promptAdd: "í”„ë¡¬í”„íŠ¸ ì¶”ê°€",
    promptEdit: "í”„ë¡¬í”„íŠ¸ í¸ì§‘",
    enterCategoryName: "ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!",
    enterTaskName: "íƒœìŠ¤í¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!",
    enterPromptContent: "í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!",
    confirmDeleteCategory: "ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
    confirmDeleteTask: "íƒœìŠ¤í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
    confirmDeletePrompt: "í”„ë¡¬í”„íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
    copyFailed: "ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!",
    jsonOnly: "JSON íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤.",
    fileReading: "íŒŒì¼ì„ ì½ëŠ” ì¤‘...",
    invalidFile: "ì˜¬ë°”ë¥¸ í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤. ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
    emptyCategoryData: "ì¹´í…Œê³ ë¦¬ ë°ì´í„°ê°€ ì—†ì–´ ë¹ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.",
    importComplete: "ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! {0}ê°œ ì¹´í…Œê³ ë¦¬ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.",
    importFailed: "ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: {0}",
    fileReadError: "íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
    exportComplete: "ğŸ“¤ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ: {0}",
    exportFailed: "âŒ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: {0}"
  },
  fr: {
    langName: "FranÃ§ais",
    appTitle: "BibliothÃ¨que de Prompts",
    fontSizeLabel: "Taille de la police:",
    exportBtn: "ğŸ“¤ Exporter",
    importBtn: "ğŸ“¥ Importer",
    importTitle: "ğŸ“¥ Importer un fichier",
    importInstructions: "Glissez-dÃ©posez un fichier JSON ou cliquez pour sÃ©lectionner",
    fileSelect: "SÃ©lectionner un fichier",
    cancel: "Annuler",
    addCategory: "+ Ajouter une nouvelle catÃ©gorie",
    noSelection: "Veuillez sÃ©lectionner un Ã©lÃ©ment Ã  gauche.<br>Cliquez sur une tÃ¢che pour voir les prompts dÃ©taillÃ©s.",
    emojiLabel: "Ã‰moji",
    saveBtn: "Enregistrer",
    taskContentPlaceholder: "Entrez le contenu liÃ© Ã  la tÃ¢che ici...",
    taskContentHint: "â€» Le contenu saisi ici sera immÃ©diatement rÃ©percutÃ© dans les prompts ci-dessous. Vous pouvez Ã©galement coller avec <b>Ctrl+V</b> !",
    completedPrompt: "2. Prompt complÃ©tÃ©",
    addPrompt: "+ Ajouter un prompt",
    copy: "ğŸ“‹ Copier",
    edit: "Modifier",
    delete: "Supprimer",
    copyComplete: "âœ… CopiÃ© !",
    showMore: "Afficher plus â–¼",
    showLess: "Afficher moins â–²",
    noSelectedPrompt: "Aucun prompt sÃ©lectionnÃ©.",
    categoryAdd: "Ajouter une catÃ©gorie",
    categoryEdit: "Modifier la catÃ©gorie",
    taskAdd: "Ajouter une tÃ¢che",
    taskEdit: "Modifier la tÃ¢che",
    promptAdd: "Ajouter un prompt",
    promptEdit: "Modifier le prompt",
    enterCategoryName: "Veuillez entrer un nom de catÃ©gorie !",
    enterTaskName: "Veuillez entrer un nom de tÃ¢che !",
    enterPromptContent: "Veuillez entrer le contenu du prompt !",
    confirmDeleteCategory: "ÃŠtes-vous sÃ»r de vouloir supprimer cette catÃ©gorie ?",
    confirmDeleteTask: "ÃŠtes-vous sÃ»r de vouloir supprimer cette tÃ¢che ?",
    confirmDeletePrompt: "ÃŠtes-vous sÃ»r de vouloir supprimer ce prompt ?",
    copyFailed: "Ã‰chec de la copie !",
    jsonOnly: "Seuls les fichiers JSON sont pris en charge.",
    fileReading: "Lecture du fichier...",
    invalidFile: "Ce n'est pas un fichier de bibliothÃ¨que de prompts valide. DonnÃ©es non trouvÃ©es.",
    emptyCategoryData: "Aucune donnÃ©e de catÃ©gorie trouvÃ©e, dÃ©marrage avec une bibliothÃ¨que vide.",
    importComplete: "Importation terminÃ©e ! {0} catÃ©gories importÃ©es. La page va maintenant Ãªtre actualisÃ©e.",
    importFailed: "Ã‰chec de l'importation : {0}",
    fileReadError: "Une erreur s'est produite lors de la lecture du fichier.",
    exportComplete: "ğŸ“¤ Exportation terminÃ©e : {0}",
    exportFailed: "âŒ Ã‰chec de l'exportation : {0}"
  },
  es: {
    langName: "EspaÃ±ol",
    appTitle: "Biblioteca de Prompts",
    fontSizeLabel: "TamaÃ±o de fuente:",
    exportBtn: "ğŸ“¤ Exportar",
    importBtn: "ğŸ“¥ Importar",
    importTitle: "ğŸ“¥ Importar archivo",
    importInstructions: "Arrastra y suelta un archivo JSON o haz clic para seleccionar",
    fileSelect: "Seleccionar archivo",
    cancel: "Cancelar",
    addCategory: "+ AÃ±adir nueva categorÃ­a",
    noSelection: "Por favor, selecciona un elemento de la izquierda.<br>Haz clic en una tarea para ver los prompts detallados.",
    emojiLabel: "Emoji",
    saveBtn: "Guardar",
    taskContentPlaceholder: "Introduce contenido relacionado con la tarea aquÃ­...",
    taskContentHint: "â€» El contenido introducido aquÃ­ se reflejarÃ¡ inmediatamente en los prompts de abajo. Â¡TambiÃ©n puedes pegar con <b>Ctrl+V</b>!",
    completedPrompt: "2. Prompt completado",
    addPrompt: "+ AÃ±adir prompt",
    copy: "ğŸ“‹ Copiar",
    edit: "Editar",
    delete: "Eliminar",
    copyComplete: "âœ… Â¡Copiado!",
    showMore: "Mostrar mÃ¡s â–¼",
    showLess: "Mostrar menos â–²",
    noSelectedPrompt: "No hay ningÃºn prompt seleccionado.",
    categoryAdd: "AÃ±adir categorÃ­a",
    categoryEdit: "Editar categorÃ­a",
    taskAdd: "AÃ±adir tarea",
    taskEdit: "Editar tarea",
    promptAdd: "AÃ±adir prompt",
    promptEdit: "Editar prompt",
    enterCategoryName: "Â¡Por favor, introduce un nombre de categorÃ­a!",
    enterTaskName: "Â¡Por favor, introduce un nombre de tarea!",
    enterPromptContent: "Â¡Por favor, introduce el contenido del prompt!",
    confirmDeleteCategory: "Â¿EstÃ¡s seguro de que quieres eliminar esta categorÃ­a?",
    confirmDeleteTask: "Â¿EstÃ¡s seguro de que quieres eliminar esta tarea?",
    confirmDeletePrompt: "Â¿EstÃ¡s seguro de que quieres eliminar este prompt?",
    copyFailed: "Â¡Error al copiar!",
    jsonOnly: "Solo se admiten archivos JSON.",
    fileReading: "Leyendo archivo...",
    invalidFile: "Este no es un archivo de biblioteca de prompts vÃ¡lido. No se encontraron datos.",
    emptyCategoryData: "No se encontraron datos de categorÃ­a, comenzando con una biblioteca vacÃ­a.",
    importComplete: "Â¡ImportaciÃ³n completa! Se importaron {0} categorÃ­as. La pÃ¡gina se actualizarÃ¡ ahora.",
    importFailed: "ImportaciÃ³n fallida: {0}",
    fileReadError: "OcurriÃ³ un error al leer el archivo.",
    exportComplete: "ğŸ“¤ ExportaciÃ³n completa: {0}",
    exportFailed: "âŒ ExportaciÃ³n fallida: {0}"
  }
};

/* ---------- ë‹¤êµ­ì–´ ì ìš© ë° ë²ˆì—­ í•¨ìˆ˜ ---------- */
function applyTranslations(lang) {
  const dict = translations[lang] || translations.ja;
  document.documentElement.lang = lang;
  document.documentElement.dataset.currentLang = lang;
  document.getElementById('langBtnLabel').textContent = dict.langName;

  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if (dict[key]) el.innerHTML = dict[key];
  });
  
  currentLang = lang;
}

function t(key, ...args) {
  const dict = translations[currentLang] || translations.ja;
  let text = dict[key] || key;
  args.forEach((arg, index) => {
    text = text.replace(`{${index}}`, arg);
  });
  return text;
}

/* ---------- ë°ì´í„° ê´€ë¦¬ ë° ë Œë”ë§ ---------- */
function initialize() {
  // ë°ì´í„° ë¡œë“œ
  data = JSON.parse(localStorage.getItem('promptUIData') || 'null') || {
    cats:[
      {id:'cat1',name:'ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ',emoji:'ğŸ“',tasks:[
        {id:'task1',name:'ãƒ¬ãƒãƒ¼ãƒˆè¦ç´„',prompts:[
          'æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã ã‘ã‚’ã¾ã¨ã‚ã¦3è¡Œã§è¦ç´„ã—ã¦ãã ã•ã„ï¼š[ã“ã“ã«å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘]',
          'æ¬¡ã®å†…å®¹ã‚’åŸºã«ã€å°å­¦ç”Ÿã§ã‚‚ç†è§£ã§ãã‚‹ã‚ˆã†ã«ã§ãã‚‹ã ã‘ç°¡å˜ã«èª¬æ˜ã—ã¦ãã ã•ã„ï¼š[ã“ã“ã«å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘]'
        ]},
        {id:'task2',name:'ç›®æ¬¡ãƒ–ãƒ¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒŸãƒ³ã‚°',prompts:[
          "'[ãƒˆãƒ”ãƒƒã‚¯]'ã¨ã„ã†ãƒ†ãƒ¼ãƒã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚å°‚é–€æ€§ã¨å‰µé€ æ€§ãŒéš›ç«‹ã¤ç›®æ¬¡ã‚’5ã¤ã®ç« ã§æ§‹æˆã—ã¦ãã ã•ã„ã€‚"
        ]},
      ]},
      {id:'cat2',name:'ãƒ¡ãƒ¼ãƒ«ä½œæˆ',emoji:'ğŸ“§',tasks:[
        {id:'task3',name:'ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãƒ¡ãƒ¼ãƒ«é€ä¿¡',prompts:[
          'æ¬¡ã®å†…å®¹ã‚’åŸºã«ã€ä¸å¯§ã§å°‚é–€çš„ãªãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚å—ä¿¡è€…ï¼š[åå‰]ã€é€ä¿¡è€…ï¼š[è‡ªåˆ†ã®åå‰]ã€é‡è¦ãªå†…å®¹ï¼š[å†…å®¹]'
        ]}
      ]}
    ]
  };
  catToggleState = JSON.parse(localStorage.getItem('catToggleState') || '{}');
  currentFontSize = localStorage.getItem('fontSizePreference') || 'medium';
  const savedLang = localStorage.getItem('ui_lang') || 'ja';

  // UI ì ìš©
  applyTranslations(savedLang);
  setFontSize(currentFontSize);
  render();
}

function saveAndRerender() {
  localStorage.setItem('promptUIData', JSON.stringify(data));
  render();
}

function render() {
  const $cat = document.getElementById('cat-container');
  $cat.innerHTML = '';
  data.cats.forEach((cat, index) => {
    const blk = document.createElement('div');
    blk.className = 'cat-block';
    blk.dataset.catId = cat.id; // ì¹´í…Œê³ ë¦¬ ID ì¶”ê°€
    blk.innerHTML = `
      <div class="cat-header" onclick="toggleCat('${cat.id}')">
        <span class="drag-handle">â‹®â‹®</span>
        <span class="cat-title">${cat.emoji || 'ğŸ“'} ${cat.name}</span>
        <div class="cat-actions ms-auto" onclick="event.stopPropagation();">
          <button class="btn btn-add btn-sm" onclick="openTaskModal('${cat.id}');event.stopPropagation();">+</button>
          <button class="btn btn-edit btn-sm" onclick="openCategoryModal('${cat.id}');event.stopPropagation();">âœï¸</button>
          <button class="btn btn-del btn-sm" onclick="deleteCategory('${cat.id}');event.stopPropagation();">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="task-list mt-1" id="cat-tasks-${cat.id}" style="display:${catToggleState[cat.id] === false ? 'none' : ''}"></div>
    `;
    $cat.appendChild(blk);
    makeCategoryDraggable(blk, index);
    
    const $tl = blk.querySelector('.task-list');
    cat.tasks.forEach((task, taskIndex) => {
      const $t = document.createElement('div');
      $t.className = 'task-item';
      $t.innerHTML = `
        <span class="task-drag-handle">â‹®</span>
        <span class="task-name" onclick="showDetail('${cat.id}','${task.id}')">${task.name}</span>
        <div class="task-actions">
          <button class="btn btn-edit btn-sm" onclick="openTaskModal('${cat.id}','${task.id}');event.stopPropagation();">âœï¸</button>
          <button class="btn btn-del btn-sm" onclick="deleteTask('${cat.id}','${task.id}');event.stopPropagation();">ğŸ—‘ï¸</button>
        </div>
      `;
      $tl.appendChild($t);
      makeTaskDraggable($t, cat.id, taskIndex);
    });
  });
  showDetail(currentCat, currentTask, true);
}

function toggleCat(id) {
  const el = document.getElementById('cat-tasks-' + id);
  if (!el) return;
  el.style.display = (el.style.display === 'none') ? '' : 'none';
  catToggleState[id] = (el.style.display !== 'none');
  localStorage.setItem('catToggleState', JSON.stringify(catToggleState));
}

/* ---------- ìƒì„¸ ì˜ì—­ í‘œì‹œ ---------- */
function showDetail(catId, taskId, onlySilent) {
  currentCat = catId;
  currentTask = taskId;
  selectedPrompt = null; // ë‹¤ë¥¸ íƒœìŠ¤í¬ë¡œ ì´ë™ ì‹œ í”„ë¡¬í”„íŠ¸ ì„ íƒ í•´ì œ

  const $area = document.getElementById('detail-area');
  const cat = data.cats.find(c => c.id === catId);
  const task = cat && cat.tasks.find(t => t.id === taskId);

  if (!cat || !task) {
    if (!onlySilent) {
      $area.innerHTML = `<div class="text-center text-secondary" style="padding:90px 0 70px 0; font-size:1.3em;" data-i18n="noSelection">${t('noSelection')}</div>`;
    }
    return;
  }

  $area.innerHTML = `
    <h3 style="font-weight:700; font-size:1.35em; margin-bottom:18px;">${task.name}</h3>
    <div class="mb-3">
      <textarea class="form-control mb-1" rows="4" placeholder="${t('taskContentPlaceholder')}" oninput="updatePreview(this.value)"></textarea>
      <div class="form-text">${t('taskContentHint')}</div>
    </div>
    <div class="d-flex align-items-center mb-2 mt-2" style="gap:10px;">
      <div style="font-weight:600; font-size:1.13em;">${t('completedPrompt')}</div>
      <button class="btn btn-primary btn-prompt-add btn-sm ms-auto" onclick="openPromptModal('${cat.id}','${task.id}')">${t('addPrompt')}</button>
    </div>
    <div id="prompts-list"></div>
  `;
  renderPrompts(task.prompts);
}

function renderPrompts(prompts, val = '') {
  const $list = document.getElementById('prompts-list');
  if (!$list) return;
  $list.innerHTML = '';

  prompts.forEach((p, i) => {
    if (selectedPrompt && (selectedPrompt.cat !== currentCat || selectedPrompt.task !== currentTask || selectedPrompt.idx !== i)) {
      return; // ì„ íƒëœ í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ë‹¤ë¥¸ ê²ƒì€ ë Œë”ë§í•˜ì§€ ì•ŠìŒ
    }

    const txt = val ? replacePH(p, val) : p;
    const box = document.createElement('div');
    box.className = 'prompt-box position-relative mb-2';

    const isChecked = selectedPrompt && selectedPrompt.cat === currentCat && selectedPrompt.task === currentTask && selectedPrompt.idx === i;
    const lineCount = (txt.match(/\n/g) || []).length + 1;
    const shouldCollapse = lineCount > 3 || txt.length > 150;
    const collapseClass = shouldCollapse ? 'collapsed' : '';
    const toggleButton = shouldCollapse ? `<button class="toggle-btn" onclick="togglePromptText(this)">${t('showMore')}</button>` : '';

    box.innerHTML = `
      <input class="form-check-input prompt-select" type="checkbox" onchange="togglePromptSelect(${i}, this)" ${isChecked ? 'checked' : ''}>
      <div class="prompt-drag-handle">â‹®</div>
      <pre class="prompt-text ${collapseClass}">${escapeHtml(txt)}</pre>
      ${toggleButton}
      <div class="prompt-actions">
        <button class="btn btn-secondary btn-sm" onclick="copyPrompt(this)">${t('copy')}</button>
        <button class="btn btn-edit btn-sm" onclick="openPromptModal(currentCat,currentTask,${i})">${t('edit')}</button>
        <button class="btn btn-del btn-sm" onclick="deletePrompt(currentCat,currentTask,${i})">${t('delete')}</button>
      </div>
    `;
    $list.appendChild(box);
    makePromptDraggable(box, currentCat, currentTask, i);
  });

  if ($list.children.length === 0 && selectedPrompt) {
    $list.innerHTML = `<div class="text-secondary" style="padding:12px 4px;">${t('noSelectedPrompt')}</div>`;
  }
}

function updatePreview(v) {
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (task) renderPrompts(task.prompts, v);
}

function togglePromptSelect(idx, cb) {
  selectedPrompt = cb.checked ? { cat: currentCat, task: currentTask, idx } : null;
  const inputVal = document.querySelector('#detail-area textarea')?.value || '';
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (task) renderPrompts(task.prompts, inputVal);
}

/* ---------- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---------- */
function replacePH(tpl, input) { return tpl.replace(/\[([^\]]*)\]/g, input || ''); }
function escapeHtml(txt) { return txt.replace(/[<>"']/g, m => ({ "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" })[m]); }
function copyPrompt(btn) {
  const promptBox = btn.closest('.prompt-box');
  const promptText = promptBox.querySelector('.prompt-text').textContent;
  navigator.clipboard.writeText(promptText)
    .then(() => { btn.textContent = t('copyComplete'); setTimeout(() => btn.textContent = t('copy'), 900); })
    .catch(() => alert(t('copyFailed')));
}
function togglePromptText(btn) {
  const promptText = btn.parentElement.querySelector('.prompt-text');
  const isCollapsed = promptText.classList.toggle('collapsed');
  btn.innerHTML = isCollapsed ? t('showMore') : t('showLess');
}

/* ---------- ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ (ìƒì„±/ìˆ˜ì •) ---------- */
function openCategoryModal(id) {
  modalMode = id ? 'edit' : 'add';
  modalType = 'cat';
  const cat = id && data.cats.find(c => c.id === id);
  modalRefObj = id ? cat : null;
  showModal(t(id ? 'categoryEdit' : 'categoryAdd'), cat ? cat.name : '', false, '', cat ? cat.emoji : 'ğŸ“');
}
function openTaskModal(catId, taskId) {
  modalMode = taskId ? 'edit' : 'add';
  modalType = 'task';
  const cat = data.cats.find(c => c.id === catId);
  const task = taskId && cat.tasks.find(t => t.id === taskId);
  modalRefObj = { cat, task };
  showModal(t(taskId ? 'taskEdit' : 'taskAdd'), task ? task.name : '', false);
}
function openPromptModal(catId, taskId, idx) {
  modalMode = idx != null ? 'edit' : 'add';
  modalType = 'prompt';
  const cat = data.cats.find(c => c.id === catId);
  const task = cat.tasks.find(t => t.id === taskId);
  modalRefObj = { cat, task, idx };
  showModal(t(idx != null ? 'promptEdit' : 'promptAdd'), '', true, idx != null ? task.prompts[idx] : '');
  selectedPrompt = null;
}
function showModal(title, val, showTA, taVal = '', emojiVal = '') {
  document.getElementById('modalTitle').textContent = title;
  const $in = document.getElementById('modalInput');
  const $ta = document.getElementById('modalTextarea');
  const $em = document.getElementById('modalEmoji');
  const $row = document.getElementById('emojiInputRow');

  $row.style.display = modalType === 'cat' ? '' : 'none';
  $em.value = emojiVal || 'ğŸ“';
  $in.style.display = showTA ? 'none' : '';
  $in.value = val || '';
  $ta.style.display = showTA ? '' : 'none';
  $ta.value = taVal || '';

  new bootstrap.Modal(document.getElementById('editModal')).show();
}
function closeModal() {
  bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
}
function saveModal() {
  const $in = document.getElementById('modalInput');
  const $ta = document.getElementById('modalTextarea');
  const $em = document.getElementById('modalEmoji');

  if (modalType === 'cat') {
    const name = $in.value.trim();
    const emoji = ($em.value || 'ğŸ“').slice(0, 2);
    if (!name) return alert(t('enterCategoryName'));
    if (modalMode === 'add') data.cats.push({ id: 'cat' + Date.now(), name, emoji, tasks: [] });
    else { modalRefObj.name = name; modalRefObj.emoji = emoji; }
  } else if (modalType === 'task') {
    const name = $in.value.trim();
    if (!name) return alert(t('enterTaskName'));
    const cat = modalRefObj.cat;
    if (modalMode === 'add') cat.tasks.push({ id: 'task' + Date.now(), name, prompts: [] });
    else modalRefObj.task.name = name;
  } else if (modalType === 'prompt') {
    const txt = $ta.value.trim();
    if (!txt) return alert(t('enterPromptContent'));
    const task = modalRefObj.task;
    if (modalMode === 'add') task.prompts.push(txt);
    else task.prompts[modalRefObj.idx] = txt;
  }
  saveAndRerender();
  closeModal();
}

/* ---------- ì‚­ì œ í•¨ìˆ˜ ---------- */
function deleteCategory(id) {
  if (!confirm(t('confirmDeleteCategory'))) return;
  data.cats = data.cats.filter(c => c.id !== id);
  if (currentCat === id) {
    currentCat = null;
    currentTask = null;
  }
  saveAndRerender();
}
function deleteTask(cid, tid) {
  const cat = data.cats.find(c => c.id === cid);
  if (!cat || !confirm(t('confirmDeleteTask'))) return;
  cat.tasks = cat.tasks.filter(t => t.id !== tid);
  if (currentTask === tid) {
    currentTask = null;
  }
  saveAndRerender();
}
function deletePrompt(cid, tid, idx) {
  const cat = data.cats.find(c => c.id === cid);
  const task = cat && cat.tasks.find(t => t.id === tid);
  if (!task || !confirm(t('confirmDeletePrompt'))) return;
  
  task.prompts.splice(idx, 1);

  if (selectedPrompt && selectedPrompt.cat === cid && selectedPrompt.task === tid) {
    if (selectedPrompt.idx === idx) {
      selectedPrompt = null; // ì‚­ì œëœ í”„ë¡¬í”„íŠ¸ê°€ ì„ íƒëœ ê²ƒì´ë©´ ì„ íƒ í•´ì œ
    } else if (selectedPrompt.idx > idx) {
      selectedPrompt.idx--; // ì‚­ì œëœ í”„ë¡¬í”„íŠ¸ë³´ë‹¤ ë’¤ì— ìˆëŠ” í”„ë¡¬í”„íŠ¸ì˜€ë‹¤ë©´ ì¸ë±ìŠ¤ ê°ì†Œ
    }
  }
  saveAndRerender();
}

/* ---------- ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¨ìˆ˜ (ê°œì„ ë¨) ---------- */
function makeCategoryDraggable(catBlock, index) {
    catBlock.draggable = true;
    catBlock.dataset.index = index;

    catBlock.addEventListener('dragstart', e => {
        draggedElement = catBlock;
        dragType = 'category';
        dragContext = { index };
        setTimeout(() => catBlock.classList.add('dragging'), 0);
    });

    catBlock.addEventListener('dragend', () => {
        catBlock.classList.remove('dragging');
        document.querySelectorAll('.cat-block.drag-over').forEach(el => el.classList.remove('drag-over'));
    });

    catBlock.addEventListener('dragover', e => {
        e.preventDefault();
        if (dragType === 'category' && draggedElement !== catBlock) {
            catBlock.classList.add('drag-over');
        }
    });
    
    catBlock.addEventListener('dragleave', () => catBlock.classList.remove('drag-over'));

    catBlock.addEventListener('drop', e => {
        e.preventDefault();
        catBlock.classList.remove('drag-over');
        if (dragType !== 'category') return;

        const fromIndex = dragContext.index;
        const toIndex = index;
        if (fromIndex === toIndex) return;

        const [movedItem] = data.cats.splice(fromIndex, 1);
        data.cats.splice(toIndex, 0, movedItem);
        saveAndRerender();
    });
}

function makeTaskDraggable(taskElement, catId, taskIndex) {
    taskElement.draggable = true;
    taskElement.dataset.catId = catId;
    taskElement.dataset.taskIndex = taskIndex;

    taskElement.addEventListener('dragstart', e => {
        e.stopPropagation();
        draggedElement = taskElement;
        dragType = 'task';
        dragContext = { catId, taskIndex };
        setTimeout(() => taskElement.classList.add('dragging'), 0);
    });

    taskElement.addEventListener('dragend', () => {
        taskElement.classList.remove('dragging');
        document.querySelectorAll('.task-item.drag-over').forEach(el => el.classList.remove('drag-over'));
    });

    taskElement.addEventListener('dragover', e => {
        e.preventDefault();
        if (dragType === 'task' && draggedElement !== taskElement) {
            taskElement.classList.add('drag-over');
        }
    });
    
    taskElement.addEventListener('dragleave', () => taskElement.classList.remove('drag-over'));

    taskElement.addEventListener('drop', e => {
        e.preventDefault();
        e.stopPropagation();
        taskElement.classList.remove('drag-over');
        if (dragType !== 'task') return;

        const { catId: fromCatId, taskIndex: fromIndex } = dragContext;
        const toCatId = catId;
        const toIndex = taskIndex;

        const fromCat = data.cats.find(c => c.id === fromCatId);
        const toCat = data.cats.find(c => c.id === toCatId);
        if (!fromCat || !toCat) return;

        const [movedTask] = fromCat.tasks.splice(fromIndex, 1);
        toCat.tasks.splice(toIndex, 0, movedTask);
        saveAndRerender();
    });
}

function makePromptDraggable(promptElement, catId, taskId, promptIndex) {
    promptElement.draggable = true;
    promptElement.dataset.promptIndex = promptIndex;

    promptElement.addEventListener('dragstart', e => {
        e.stopPropagation();
        draggedElement = promptElement;
        dragType = 'prompt';
        dragContext = { catId, taskId, promptIndex };
        setTimeout(() => promptElement.classList.add('dragging'), 0);
    });

    promptElement.addEventListener('dragend', () => {
        promptElement.classList.remove('dragging');
        document.querySelectorAll('.prompt-box.drag-over').forEach(el => el.classList.remove('drag-over'));
    });

    promptElement.addEventListener('dragover', e => {
        e.preventDefault();
        if (dragType === 'prompt' && draggedElement !== promptElement) {
            promptElement.classList.add('drag-over');
        }
    });

    promptElement.addEventListener('dragleave', () => promptElement.classList.remove('drag-over'));

    promptElement.addEventListener('drop', e => {
        e.preventDefault();
        e.stopPropagation();
        promptElement.classList.remove('drag-over');
        if (dragType !== 'prompt') return;

        const { promptIndex: fromIndex } = dragContext;
        const toIndex = promptIndex;
        
        const cat = data.cats.find(c => c.id === catId);
        const task = cat?.tasks.find(t => t.id === taskId);
        if (!task) return;

        const [movedPrompt] = task.prompts.splice(fromIndex, 1);
        task.prompts.splice(toIndex, 0, movedPrompt);
        saveAndRerender();
    });
}


/* ---------- UI ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ (ê¸€ê¼´, ê°€ì ¸ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°) ---------- */
function setFontSize(size) {
  document.body.classList.remove('font-size-small', 'font-size-medium', 'font-size-large', 'font-size-xlarge');
  document.body.classList.add(`font-size-${size}`);
  document.querySelectorAll('.font-size-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.size === size);
  });
  currentFontSize = size;
  localStorage.setItem('fontSizePreference', size);
}

function exportData() {
  try {
    const exportObject = {
      promptUIData: data,
      catToggleState: catToggleState,
      fontSizePreference: currentFontSize,
      exportDate: new Date().toISOString(),
      version: '1.2'
    };
    const jsonString = JSON.stringify(exportObject, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
    const now = new Date();
    const filename = `prompt_library_${now.toISOString().slice(0, 10).replace(/-/g, '')}.json`;
    
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
    showTempMessage(t('exportComplete', filename), 'success');
  } catch (error) {
    showTempMessage(t('exportFailed', error.message), 'error');
  }
}

function toggleImportArea() {
  const area = document.getElementById('importArea');
  area.style.display = area.style.display === 'none' ? 'block' : 'none';
  clearStatus();
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (file) processFile(file);
}

function processFile(file) {
  if (!file.name.toLowerCase().endsWith('.json')) {
    return showStatus(t('jsonOnly'), 'error');
  }
  showStatus(t('fileReading'), 'info');
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const obj = JSON.parse(e.target.result);
      let dataToImport = obj.promptUIData;

      if (!dataToImport || !Array.isArray(dataToImport.cats)) {
         throw new Error(t('invalidFile'));
      }
      
      // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ë° ë³´ì •
      dataToImport.cats.forEach((cat, i) => {
        cat.id = cat.id || 'cat' + Date.now() + i;
        cat.tasks = cat.tasks || [];
        cat.tasks.forEach((task, j) => {
          task.id = task.id || 'task' + Date.now() + j;
          task.prompts = task.prompts || [];
        });
      });

      localStorage.setItem('promptUIData', JSON.stringify(dataToImport));
      localStorage.setItem('catToggleState', JSON.stringify(obj.catToggleState || {}));
      localStorage.setItem('fontSizePreference', obj.fontSizePreference || 'medium');
      
      showStatus(t('importComplete', dataToImport.cats.length), 'success');
      setTimeout(() => location.reload(), 1500);
    } catch (err) {
      showStatus(t('importFailed', err.message), 'error');
    }
  };
  reader.onerror = () => showStatus(t('fileReadError'), 'error');
  reader.readAsText(file);
}

function showStatus(message, type = 'info') {
  const statusDiv = document.getElementById('statusMessage');
  statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
}
function clearStatus() {
  document.getElementById('statusMessage').innerHTML = '';
}

function showTempMessage(message, type = 'info', duration = 3000) {
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; z-index: 9999; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;`;
  if (type === 'success') {
    messageDiv.style.background = '#d4edda'; messageDiv.style.color = '#155724'; messageDiv.style.border = '1px solid #c3e6cb';
  } else if (type === 'error') {
    messageDiv.style.background = '#f8d7da'; messageDiv.style.color = '#721c24'; messageDiv.style.border = '1px solid #f5c6cb';
  }
  messageDiv.textContent = message;
  document.body.appendChild(messageDiv);
  setTimeout(() => {
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateX(100%)';
    setTimeout(() => messageDiv.remove(), 300);
  }, duration);
}

/* ---------- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---------- */
document.addEventListener('DOMContentLoaded', initialize);

document.addEventListener('click', e => {
  if (e.target.matches('[data-lang]')) {
    e.preventDefault();
    const lang = e.target.dataset.lang;
    localStorage.setItem('ui_lang', lang);
    applyTranslations(lang);
  }
});

const importArea = document.getElementById('importArea');
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  document.body.addEventListener(eventName, e => {
    if (!importArea.contains(e.target)) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, false);
  importArea.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
  }, false);
});
['dragenter', 'dragover'].forEach(eventName => {
  importArea.addEventListener(eventName, () => importArea.classList.add('dragover'), false);
});
['dragleave', 'drop'].forEach(eventName => {
  importArea.addEventListener(eventName, () => importArea.classList.remove('dragover'), false);
});
importArea.addEventListener('drop', e => {
  const files = e.dataTransfer.files;
  if (files.length > 0) processFile(files[0]);
}, false);

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
