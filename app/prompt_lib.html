<!DOCTYPE html>
<html lang="ja" data-current-lang="ja">
<head>
  <meta charset="UTF-8">
  <title data-i18n="appTitle">プロンプトライブラリ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f5f6fa; }
    .sidebar   { min-width:350px; max-width:420px; background:#fff; border-radius:18px; padding:24px; margin:22px 0 22px 28px; box-shadow:0 3px 15px rgba(0,0,0,.08);}
    .main-pane { background:#fff; border-radius:18px; margin:22px 28px 22px 0; padding:32px 32px 42px 32px; box-shadow:0 3px 15px rgba(0,0,0,.08);}
    .cat-block { margin-bottom:30px; border:1.5px solid #eee; border-radius:13px; background:#fafbfc; transition: all 0.2s ease; }
    .cat-header{ display:flex; align-items:center; gap:10px; font-size:1.18em; font-weight:700; padding:16px 22px 0 18px; cursor:pointer;}
    .cat-title { color:#1567c6; letter-spacing:-0.3px;}
    .cat-actions button{ margin-left:7px; }
    .task-list { padding:7px 14px 13px 18px; }
    .task-item { display:flex; align-items:center; border-radius:7px; margin-bottom:8px; padding:7px 8px 7px 11px; background:#fff; border:1px solid #eee; cursor: move;}
    .task-name { flex:1; font-size:1.07em; color:#212b36; cursor:pointer;}
    .task-actions button{ margin-left:5px; }
    .btn-add   { background:#15c645; color:#fff; }
    .btn-edit  { background:#ffc107; color:#000;}
    .btn-del   { background:#dc3545; color:#fff;}

    /* ▼ 드래그 관련 스타일 */
    .dragging { opacity: 0.5; transform: scale(0.95); z-index: 1000; }
    .drag-over { border: 2px dashed #007bff !important; background: #e3f2fd !important; }
    .cat-block.drag-over { transform: translateY(-2px); }
    .task-item.drag-over { border-color: #28a745 !important; }
    .prompt-box.drag-over { border-color: #17a2b8 !important; }

    .drag-handle { color: #666; font-size: 1.2em; cursor: grab; padding: 0 8px; margin-left: -8px; }
    .drag-handle:hover { color: #333; }
    .drag-handle:active { cursor: grabbing; }
    .task-drag-handle { color: #666; font-size: 1em; cursor: grab; padding: 0 6px; margin-left: -6px; }
    .task-drag-handle:hover { color: #333; }
    .task-drag-handle:active { cursor: grabbing; }
    .prompt-drag-handle { color: #666; font-size: 1.1em; cursor: grab; padding: 4px 8px; position: absolute; left: 12px; top: 35px; z-index: 10; }
    .prompt-drag-handle:hover { color: #333; }
    .prompt-drag-handle:active { cursor: grabbing; }

    /* ▼ 선택 구용 체크박스 배치 (드래그 핸들과 겹치지 않도록 조정) */
    .prompt-select { position:absolute; left:12px; top:10px; transform:scale(1.15); }
    .prompt-box    { background:#f5faff; border:1.3px solid #dde3eb; border-radius:8px; padding:18px 14px 14px 45px; margin-bottom:16px; position:relative; cursor: move;}
    .prompt-actions button{ margin-right:7px; }
    .prompt-actions{ position:absolute; right:18px; top:10px;}
    .form-control{ font-size:1.08em;}
    .btn-prompt-add{ margin-left:auto; }
    
    /* ▼ 문자크기 조정관련 스타일 */
    .font-size-controls { display: flex; gap: 5px; margin-bottom: 15px; align-items: center; }
    .font-size-btn { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }
    .font-size-btn:hover { background: #e9ecef; }
    .font-size-btn.active { background: #007bff; color: white; border-color: #007bff; }
    
    /* 문자크기 클래스 */
    .font-size-small { font-size: 0.85em !important; }
    .font-size-small .form-control, .font-size-small pre, .font-size-small .task-name, .font-size-small .cat-title { font-size: 0.95em !important; }
    .font-size-medium { font-size: 1em !important; }
    .font-size-medium .form-control, .font-size-medium pre, .font-size-medium .task-name, .font-size-medium .cat-title { font-size: 1.07em !important; }
    .font-size-large { font-size: 1.15em !important; }
    .font-size-large .form-control, .font-size-large pre, .font-size-large .task-name, .font-size-large .cat-title { font-size: 1.25em !important; }
    .font-size-xlarge { font-size: 1.3em !important; }
    .font-size-xlarge .form-control, .font-size-xlarge pre, .font-size-xlarge .task-name, .font-size-xlarge .cat-title { font-size: 1.4em !important; }
    
    /* ▼ 프롬프트 접기관련 스타일 */
    .prompt-text { margin-bottom: 0; font-size: 1.06em; white-space: pre-wrap; word-wrap: break-word; }
    .prompt-text.collapsed { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; white-space: pre-wrap; }
    .toggle-btn { background: none; border: none; color: #007bff; font-size: 0.9em; padding: 4px 0; margin-top: 8px; cursor: pointer; text-decoration: underline; }
    .toggle-btn:hover { color: #0056b3; }

    /* ▼ 임포트영역 스타일 */
    .import-area { border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; background: #f8f9fa; transition: all 0.3s ease; }
    .import-area.dragover { border-color: #007bff; background: #e3f2fd; }
    .file-input-hidden { display: none; }
    .status-message { margin-top: 10px; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; }
    .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    
    /* 언어선택바 스타일 */
    #langBar { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #eee; }
    
    @media (max-width:900px){
      .sidebar, .main-pane{ margin:10px; padding:12px; }
      .main-pane{ padding-top:17px;}
    }
  </style>
</head>
<body>

  <!-- ▸▸ 글로벌 언어선택바 ◂◂ -->
  <div class="d-flex justify-content-end align-items-center p-2" id="langBar">
    <div class="btn-group">
      <button id="langBtn" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        🌐 <span id="langBtnLabel">日本語</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="#" data-lang="ja">日本語</a></li>
        <li><a class="dropdown-item" href="#" data-lang="en">English</a></li>
        <li><a class="dropdown-item" href="#" data-lang="zh">简体中文</a></li>
        <li><a class="dropdown-item" href="#" data-lang="ko">한국어</a></li>
        <li><a class="dropdown-item" href="#" data-lang="fr">Français</a></li>
        <li><a class="dropdown-item" href="#" data-lang="es">Español</a></li>
      </ul>
    </div>
  </div>

  <div class="d-flex flex-row" style="gap:32px;">
    <!-- ▸▸ 사이드바 ◂◂ -->
    <div class="sidebar">
      <h2 class="mb-3" style="font-weight:800; font-size:1.37em;">
        <span style="font-size:1.21em; margin-right:8px;">📚</span>
        <span data-i18n="appTitle">プロンプトライブラリ</span>
      </h2>

      <!-- 문자크기 조정 -->
      <div class="font-size-controls">
        <span data-i18n="fontSizeLabel" style="font-size: 0.9em; color: #666; margin-right: 8px;">文字サイズ:</span>
        <div class="font-size-btn" data-size="small" onclick="setFontSize('small')" title="小">A</div>
        <div class="font-size-btn active" data-size="medium" onclick="setFontSize('medium')" title="標準">A</div>
        <div class="font-size-btn" data-size="large" onclick="setFontSize('large')" title="大" style="font-size: 1.1em;">A</div>
        <div class="font-size-btn" data-size="xlarge" onclick="setFontSize('xlarge')" title="特大" style="font-size: 1.2em;">A</div>
      </div>

      <!-- 익스포트/임포트 버튼 -->
      <div class="d-grid gap-2 mb-3">
        <button class="btn btn-outline-secondary" onclick="exportData()" data-i18n="exportBtn">📤 エクスポート</button>
        <button class="btn btn-outline-secondary" onclick="toggleImportArea()" data-i18n="importBtn">📥 インポート</button>
      </div>

      <!-- 임포트영역（표시/비표시 토글） -->
      <div id="importArea" class="import-area" style="display: none;">
        <div class="mb-2">
          <strong data-i18n="importTitle">📥 ファイルをインポート</strong>
        </div>
        <div class="mb-2" style="font-size: 0.9em; color: #666;" data-i18n="importInstructions">
          JSONファイルをドラッグするかクリックして選択してください
        </div>
        <input type="file" id="fileInput" class="file-input-hidden" accept=".json" onchange="handleFileSelect(event)">
        <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('fileInput').click()" data-i18n="fileSelect">
          ファイル選択
        </button>
        <div class="mt-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="toggleImportArea()" data-i18n="cancel">キャンセル</button>
        </div>
        <div id="statusMessage"></div>
      </div>

      <button class="btn btn-primary w-100 mb-3" onclick="openCategoryModal()" data-i18n="addCategory">＋ 新しいカテゴリを追加</button>
      <div id="cat-container"></div>
    </div>

    <!-- ▸▸ 메인상세 ◂◂ -->
    <div class="main-pane flex-fill">
      <div id="detail-area" style="min-height:380px;">
        <div class="text-center text-secondary" style="padding:90px 0 70px 0; font-size:1.3em;" data-i18n="noSelection">
          左側から項目を選択してください。<br>タスクをクリックすると詳細プロンプトが表示されます。
        </div>
      </div>
    </div>
  </div>

  <!-- ▸▸ 공통모달 ◂◂ -->
  <div class="modal" tabindex="-1" id="editModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 id="modalTitle" class="modal-title"></h5></div>
        <div class="modal-body">
          <div id="emojiInputRow" style="display:none;">
            <label for="modalEmoji" class="form-label mb-1" data-i18n="emojiLabel">絵文字</label>
            <input type="text" id="modalEmoji" class="form-control mb-2" placeholder="例: 📁" maxlength="2" style="width:90px; display:inline-block;">
          </div>
          <input type="text" id="modalInput" class="form-control mb-2" placeholder="">
          <textarea id="modalTextarea" class="form-control" rows="8" style="display:none; resize: both; min-height: 200px; min-width: 300px;"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()" data-i18n="cancel">キャンセル</button>
          <button type="button" class="btn btn-primary" onclick="saveModal()" data-i18n="saveBtn">保存</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- 전역 변수 및 상태 관리 ---------- */
let data; // 데이터 객체
let currentCat = null, currentTask = null; // 현재 선택된 카테고리 및 태스크 ID
let modalMode = null, modalRefObj = null, modalType = null; // 모달 관련 변수
let catToggleState; // 카테고리 접기/펴기 상태
let currentFontSize; // 현재 글꼴 크기
let selectedPrompt = null; // {cat, task, idx} 또는 null
let currentLang = 'ja'; // 현재 언어
let draggedElement = null, dragType = null, dragContext = null; // 드래그 앤 드롭 관련 변수

/* ---------- 다국어 리소스 ---------- */
const translations = {
  ja: {
    langName: "日本語",
    appTitle: "プロンプトライブラリ",
    fontSizeLabel: "文字サイズ:",
    exportBtn: "📤 エクスポート",
    importBtn: "📥 インポート",
    importTitle: "📥 ファイルをインポート",
    importInstructions: "JSONファイルをドラッグするかクリックして選択してください",
    fileSelect: "ファイル選択",
    cancel: "キャンセル",
    addCategory: "＋ 新しいカテゴリを追加",
    noSelection: "左側から項目を選択してください。<br>タスクをクリックすると詳細プロンプトが表示されます。",
    emojiLabel: "絵文字",
    saveBtn: "保存",
    taskContentPlaceholder: "タスク関連の内容を入力してください...",
    taskContentHint: "※ 内容を入力すると以下のプロンプトにすぐに反映されます。<b>Ctrl+V</b>で貼り付けも可能です！",
    completedPrompt: "2. 完成したプロンプト",
    addPrompt: "＋ プロンプト追加",
    copy: "📋 コピー",
    edit: "編集",
    delete: "削除",
    copyComplete: "✅ コピー完了",
    showMore: "もっと見る ▼",
    showLess: "折りたたむ ▲",
    noSelectedPrompt: "選択されたプロンプトがありません。",
    categoryAdd: "カテゴリ追加",
    categoryEdit: "カテゴリ編集",
    taskAdd: "タスク追加",
    taskEdit: "タスク編集",
    promptAdd: "プロンプト追加",
    promptEdit: "プロンプト編集",
    enterCategoryName: "カテゴリ名を入力してください！",
    enterTaskName: "タスク名を入力してください！",
    enterPromptContent: "プロンプトの内容を入力してください！",
    confirmDeleteCategory: "カテゴリを削除しますか？",
    confirmDeleteTask: "タスクを削除しますか？",
    confirmDeletePrompt: "プロンプトを削除しますか？",
    copyFailed: "コピーに失敗しました！",
    jsonOnly: "JSONファイルのみサポートしています。",
    fileReading: "ファイルを読み込み中...",
    invalidFile: "正しいプロンプトライブラリファイルではありません。データが見つかりません。",
    emptyCategoryData: "カテゴリデータがないため、空のライブラリで開始します。",
    importComplete: "インポート完了！{0}個のカテゴリをインポートしました。ページを更新します。",
    importFailed: "インポートに失敗しました: {0}",
    fileReadError: "ファイル読み込み中にエラーが発生しました。",
    exportComplete: "📤 エクスポート完了: {0}",
    exportFailed: "❌ エクスポート失敗: {0}"
  },
  en: {
    langName: "English",
    appTitle: "Prompt Library",
    fontSizeLabel: "Font Size:",
    exportBtn: "📤 Export",
    importBtn: "📥 Import",
    importTitle: "📥 Import File",
    importInstructions: "Drag & drop a JSON file or click to select",
    fileSelect: "Select File",
    cancel: "Cancel",
    addCategory: "+ Add New Category",
    noSelection: "Please select an item from the left.<br>Click a task to see the detailed prompts.",
    emojiLabel: "Emoji",
    saveBtn: "Save",
    taskContentPlaceholder: "Enter task-related content here...",
    taskContentHint: "※ Content entered here will be immediately reflected in the prompts below. You can also paste with <b>Ctrl+V</b>!",
    completedPrompt: "2. Completed Prompt",
    addPrompt: "+ Add Prompt",
    copy: "📋 Copy",
    edit: "Edit",
    delete: "Delete",
    copyComplete: "✅ Copied!",
    showMore: "Show More ▼",
    showLess: "Show Less ▲",
    noSelectedPrompt: "No prompt selected.",
    categoryAdd: "Add Category",
    categoryEdit: "Edit Category",
    taskAdd: "Add Task",
    taskEdit: "Edit Task",
    promptAdd: "Add Prompt",
    promptEdit: "Edit Prompt",
    enterCategoryName: "Please enter a category name!",
    enterTaskName: "Please enter a task name!",
    enterPromptContent: "Please enter the prompt content!",
    confirmDeleteCategory: "Are you sure you want to delete this category?",
    confirmDeleteTask: "Are you sure you want to delete this task?",
    confirmDeletePrompt: "Are you sure you want to delete this prompt?",
    copyFailed: "Failed to copy!",
    jsonOnly: "Only JSON files are supported.",
    fileReading: "Reading file...",
    invalidFile: "This is not a valid prompt library file. Data not found.",
    emptyCategoryData: "No category data found, starting with an empty library.",
    importComplete: "Import complete! Imported {0} categories. The page will now refresh.",
    importFailed: "Import failed: {0}",
    fileReadError: "An error occurred while reading the file.",
    exportComplete: "📤 Export complete: {0}",
    exportFailed: "❌ Export failed: {0}"
  },
  zh: {
    langName: "简体中文",
    appTitle: "提示词库",
    fontSizeLabel: "字体大小:",
    exportBtn: "📤 导出",
    importBtn: "📥 导入",
    importTitle: "📥 导入文件",
    importInstructions: "拖放JSON文件或点击选择",
    fileSelect: "选择文件",
    cancel: "取消",
    addCategory: "＋ 添加新分类",
    noSelection: "请从左侧选择一个项目。<br>点击任务以查看详细提示。",
    emojiLabel: "表情符号",
    saveBtn: "保存",
    taskContentPlaceholder: "在此输入任务相关内容...",
    taskContentHint: "※ 输入的内容将立即反映在下面的提示中。您也可以使用 <b>Ctrl+V</b> 粘贴！",
    completedPrompt: "2. 完成的提示",
    addPrompt: "＋ 添加提示",
    copy: "📋 复制",
    edit: "编辑",
    delete: "删除",
    copyComplete: "✅ 已复制",
    showMore: "显示更多 ▼",
    showLess: "收起 ▲",
    noSelectedPrompt: "未选择任何提示。",
    categoryAdd: "添加分类",
    categoryEdit: "编辑分类",
    taskAdd: "添加任务",
    taskEdit: "编辑任务",
    promptAdd: "添加提示",
    promptEdit: "编辑提示",
    enterCategoryName: "请输入分类名称！",
    enterTaskName: "请输入任务名称！",
    enterPromptContent: "请输入提示内容！",
    confirmDeleteCategory: "确定要删除此分类吗？",
    confirmDeleteTask: "确定要删除此任务吗？",
    confirmDeletePrompt: "确定要删除此提示吗？",
    copyFailed: "复制失败！",
    jsonOnly: "仅支持JSON文件。",
    fileReading: "正在读取文件...",
    invalidFile: "不是有效的提示库文件。未找到数据。",
    emptyCategoryData: "未找到分类数据，将以空库开始。",
    importComplete: "导入完成！已导入 {0} 个分类。页面即将刷新。",
    importFailed: "导入失败：{0}",
    fileReadError: "读取文件时发生错误。",
    exportComplete: "📤 导出完成: {0}",
    exportFailed: "❌ 导出失败: {0}"
  },
  ko: {
    langName: "한국어",
    appTitle: "프롬프트 라이브러리",
    fontSizeLabel: "글꼴 크기:",
    exportBtn: "📤 내보내기",
    importBtn: "📥 가져오기",
    importTitle: "📥 파일 가져오기",
    importInstructions: "JSON 파일을 드래그하거나 클릭하여 선택하세요",
    fileSelect: "파일 선택",
    cancel: "취소",
    addCategory: "＋ 새 카테고리 추가",
    noSelection: "왼쪽에서 항목을 선택하세요.<br>태스크를 클릭하면 상세 프롬프트가 표시됩니다.",
    emojiLabel: "이모지",
    saveBtn: "저장",
    taskContentPlaceholder: "태스크 관련 내용을 입력하세요...",
    taskContentHint: "※ 내용을 입력하면 아래 프롬프트에 즉시 반영됩니다. <b>Ctrl+V</b>로 붙여넣기도 가능해요!",
    completedPrompt: "2. 완성된 프롬프트",
    addPrompt: "＋ 프롬프트 추가",
    copy: "📋 복사",
    edit: "편집",
    delete: "삭제",
    copyComplete: "✅ 복사 완료",
    showMore: "더 보기 ▼",
    showLess: "접기 ▲",
    noSelectedPrompt: "선택된 프롬프트가 없습니다.",
    categoryAdd: "카테고리 추가",
    categoryEdit: "카테고리 편집",
    taskAdd: "태스크 추가",
    taskEdit: "태스크 편집",
    promptAdd: "프롬프트 추가",
    promptEdit: "프롬프트 편집",
    enterCategoryName: "카테고리명을 입력해주세요!",
    enterTaskName: "태스크명을 입력해주세요!",
    enterPromptContent: "프롬프트 내용을 입력해주세요!",
    confirmDeleteCategory: "카테고리를 삭제하시겠습니까?",
    confirmDeleteTask: "태스크를 삭제하시겠습니까?",
    confirmDeletePrompt: "프롬프트를 삭제하시겠습니까?",
    copyFailed: "복사에 실패했습니다!",
    jsonOnly: "JSON 파일만 지원합니다.",
    fileReading: "파일을 읽는 중...",
    invalidFile: "올바른 프롬프트 라이브러리 파일이 아닙니다. 데이터를 찾을 수 없습니다.",
    emptyCategoryData: "카테고리 데이터가 없어 빈 라이브러리로 시작합니다.",
    importComplete: "가져오기 완료! {0}개 카테고리를 가져왔습니다. 페이지를 새로고침합니다.",
    importFailed: "가져오기에 실패했습니다: {0}",
    fileReadError: "파일을 읽는 중 오류가 발생했습니다.",
    exportComplete: "📤 내보내기 완료: {0}",
    exportFailed: "❌ 내보내기 실패: {0}"
  },
  fr: {
    langName: "Français",
    appTitle: "Bibliothèque de Prompts",
    fontSizeLabel: "Taille de la police:",
    exportBtn: "📤 Exporter",
    importBtn: "📥 Importer",
    importTitle: "📥 Importer un fichier",
    importInstructions: "Glissez-déposez un fichier JSON ou cliquez pour sélectionner",
    fileSelect: "Sélectionner un fichier",
    cancel: "Annuler",
    addCategory: "+ Ajouter une nouvelle catégorie",
    noSelection: "Veuillez sélectionner un élément à gauche.<br>Cliquez sur une tâche pour voir les prompts détaillés.",
    emojiLabel: "Émoji",
    saveBtn: "Enregistrer",
    taskContentPlaceholder: "Entrez le contenu lié à la tâche ici...",
    taskContentHint: "※ Le contenu saisi ici sera immédiatement répercuté dans les prompts ci-dessous. Vous pouvez également coller avec <b>Ctrl+V</b> !",
    completedPrompt: "2. Prompt complété",
    addPrompt: "+ Ajouter un prompt",
    copy: "📋 Copier",
    edit: "Modifier",
    delete: "Supprimer",
    copyComplete: "✅ Copié !",
    showMore: "Afficher plus ▼",
    showLess: "Afficher moins ▲",
    noSelectedPrompt: "Aucun prompt sélectionné.",
    categoryAdd: "Ajouter une catégorie",
    categoryEdit: "Modifier la catégorie",
    taskAdd: "Ajouter une tâche",
    taskEdit: "Modifier la tâche",
    promptAdd: "Ajouter un prompt",
    promptEdit: "Modifier le prompt",
    enterCategoryName: "Veuillez entrer un nom de catégorie !",
    enterTaskName: "Veuillez entrer un nom de tâche !",
    enterPromptContent: "Veuillez entrer le contenu du prompt !",
    confirmDeleteCategory: "Êtes-vous sûr de vouloir supprimer cette catégorie ?",
    confirmDeleteTask: "Êtes-vous sûr de vouloir supprimer cette tâche ?",
    confirmDeletePrompt: "Êtes-vous sûr de vouloir supprimer ce prompt ?",
    copyFailed: "Échec de la copie !",
    jsonOnly: "Seuls les fichiers JSON sont pris en charge.",
    fileReading: "Lecture du fichier...",
    invalidFile: "Ce n'est pas un fichier de bibliothèque de prompts valide. Données non trouvées.",
    emptyCategoryData: "Aucune donnée de catégorie trouvée, démarrage avec une bibliothèque vide.",
    importComplete: "Importation terminée ! {0} catégories importées. La page va maintenant être actualisée.",
    importFailed: "Échec de l'importation : {0}",
    fileReadError: "Une erreur s'est produite lors de la lecture du fichier.",
    exportComplete: "📤 Exportation terminée : {0}",
    exportFailed: "❌ Échec de l'exportation : {0}"
  },
  es: {
    langName: "Español",
    appTitle: "Biblioteca de Prompts",
    fontSizeLabel: "Tamaño de fuente:",
    exportBtn: "📤 Exportar",
    importBtn: "📥 Importar",
    importTitle: "📥 Importar archivo",
    importInstructions: "Arrastra y suelta un archivo JSON o haz clic para seleccionar",
    fileSelect: "Seleccionar archivo",
    cancel: "Cancelar",
    addCategory: "+ Añadir nueva categoría",
    noSelection: "Por favor, selecciona un elemento de la izquierda.<br>Haz clic en una tarea para ver los prompts detallados.",
    emojiLabel: "Emoji",
    saveBtn: "Guardar",
    taskContentPlaceholder: "Introduce contenido relacionado con la tarea aquí...",
    taskContentHint: "※ El contenido introducido aquí se reflejará inmediatamente en los prompts de abajo. ¡También puedes pegar con <b>Ctrl+V</b>!",
    completedPrompt: "2. Prompt completado",
    addPrompt: "+ Añadir prompt",
    copy: "📋 Copiar",
    edit: "Editar",
    delete: "Eliminar",
    copyComplete: "✅ ¡Copiado!",
    showMore: "Mostrar más ▼",
    showLess: "Mostrar menos ▲",
    noSelectedPrompt: "No hay ningún prompt seleccionado.",
    categoryAdd: "Añadir categoría",
    categoryEdit: "Editar categoría",
    taskAdd: "Añadir tarea",
    taskEdit: "Editar tarea",
    promptAdd: "Añadir prompt",
    promptEdit: "Editar prompt",
    enterCategoryName: "¡Por favor, introduce un nombre de categoría!",
    enterTaskName: "¡Por favor, introduce un nombre de tarea!",
    enterPromptContent: "¡Por favor, introduce el contenido del prompt!",
    confirmDeleteCategory: "¿Estás seguro de que quieres eliminar esta categoría?",
    confirmDeleteTask: "¿Estás seguro de que quieres eliminar esta tarea?",
    confirmDeletePrompt: "¿Estás seguro de que quieres eliminar este prompt?",
    copyFailed: "¡Error al copiar!",
    jsonOnly: "Solo se admiten archivos JSON.",
    fileReading: "Leyendo archivo...",
    invalidFile: "Este no es un archivo de biblioteca de prompts válido. No se encontraron datos.",
    emptyCategoryData: "No se encontraron datos de categoría, comenzando con una biblioteca vacía.",
    importComplete: "¡Importación completa! Se importaron {0} categorías. La página se actualizará ahora.",
    importFailed: "Importación fallida: {0}",
    fileReadError: "Ocurrió un error al leer el archivo.",
    exportComplete: "📤 Exportación completa: {0}",
    exportFailed: "❌ Exportación fallida: {0}"
  }
};

/* ---------- 다국어 적용 및 번역 함수 ---------- */
function applyTranslations(lang) {
  const dict = translations[lang] || translations.ja;
  document.documentElement.lang = lang;
  document.documentElement.dataset.currentLang = lang;
  document.getElementById('langBtnLabel').textContent = dict.langName;

  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if (dict[key]) el.innerHTML = dict[key];
  });
  
  currentLang = lang;
}

function t(key, ...args) {
  const dict = translations[currentLang] || translations.ja;
  let text = dict[key] || key;
  args.forEach((arg, index) => {
    text = text.replace(`{${index}}`, arg);
  });
  return text;
}

/* ---------- 데이터 관리 및 렌더링 ---------- */
function initialize() {
  // 데이터 로드
  data = JSON.parse(localStorage.getItem('promptUIData') || 'null') || {
    cats:[
      {id:'cat1',name:'レポート作成',emoji:'📝',tasks:[
        {id:'task1',name:'レポート要約',prompts:[
          '次のテキストを重要なポイントだけをまとめて3行で要約してください：[ここに内容を貼り付け]',
          '次の内容を基に、小学生でも理解できるようにできるだけ簡単に説明してください：[ここに内容を貼り付け]'
        ]},
        {id:'task2',name:'目次ブレインストーミング',prompts:[
          "'[トピック]'というテーマのレポートを作成しようとしています。専門性と創造性が際立つ目次を5つの章で構成してください。"
        ]},
      ]},
      {id:'cat2',name:'メール作成',emoji:'📧',tasks:[
        {id:'task3',name:'フォローアップメール送信',prompts:[
          '次の内容を基に、丁寧で専門的なフォローアップメールを作成してください。受信者：[名前]、送信者：[自分の名前]、重要な内容：[内容]'
        ]}
      ]}
    ]
  };
  catToggleState = JSON.parse(localStorage.getItem('catToggleState') || '{}');
  currentFontSize = localStorage.getItem('fontSizePreference') || 'medium';
  const savedLang = localStorage.getItem('ui_lang') || 'ja';

  // UI 적용
  applyTranslations(savedLang);
  setFontSize(currentFontSize);
  render();
}

function saveAndRerender() {
  localStorage.setItem('promptUIData', JSON.stringify(data));
  render();
}

function render() {
  const $cat = document.getElementById('cat-container');
  $cat.innerHTML = '';
  data.cats.forEach((cat, index) => {
    const blk = document.createElement('div');
    blk.className = 'cat-block';
    blk.dataset.catId = cat.id; // 카테고리 ID 추가
    blk.innerHTML = `
      <div class="cat-header" onclick="toggleCat('${cat.id}')">
        <span class="drag-handle">⋮⋮</span>
        <span class="cat-title">${cat.emoji || '📁'} ${cat.name}</span>
        <div class="cat-actions ms-auto" onclick="event.stopPropagation();">
          <button class="btn btn-add btn-sm" onclick="openTaskModal('${cat.id}');event.stopPropagation();">+</button>
          <button class="btn btn-edit btn-sm" onclick="openCategoryModal('${cat.id}');event.stopPropagation();">✏️</button>
          <button class="btn btn-del btn-sm" onclick="deleteCategory('${cat.id}');event.stopPropagation();">🗑️</button>
        </div>
      </div>
      <div class="task-list mt-1" id="cat-tasks-${cat.id}" style="display:${catToggleState[cat.id] === false ? 'none' : ''}"></div>
    `;
    $cat.appendChild(blk);
    makeCategoryDraggable(blk, index);
    
    const $tl = blk.querySelector('.task-list');
    cat.tasks.forEach((task, taskIndex) => {
      const $t = document.createElement('div');
      $t.className = 'task-item';
      $t.innerHTML = `
        <span class="task-drag-handle">⋮</span>
        <span class="task-name" onclick="showDetail('${cat.id}','${task.id}')">${task.name}</span>
        <div class="task-actions">
          <button class="btn btn-edit btn-sm" onclick="openTaskModal('${cat.id}','${task.id}');event.stopPropagation();">✏️</button>
          <button class="btn btn-del btn-sm" onclick="deleteTask('${cat.id}','${task.id}');event.stopPropagation();">🗑️</button>
        </div>
      `;
      $tl.appendChild($t);
      makeTaskDraggable($t, cat.id, taskIndex);
    });
  });
  showDetail(currentCat, currentTask, true);
}

function toggleCat(id) {
  const el = document.getElementById('cat-tasks-' + id);
  if (!el) return;
  el.style.display = (el.style.display === 'none') ? '' : 'none';
  catToggleState[id] = (el.style.display !== 'none');
  localStorage.setItem('catToggleState', JSON.stringify(catToggleState));
}

/* ---------- 상세 영역 표시 ---------- */
function showDetail(catId, taskId, onlySilent) {
  currentCat = catId;
  currentTask = taskId;
  selectedPrompt = null; // 다른 태스크로 이동 시 프롬프트 선택 해제

  const $area = document.getElementById('detail-area');
  const cat = data.cats.find(c => c.id === catId);
  const task = cat && cat.tasks.find(t => t.id === taskId);

  if (!cat || !task) {
    if (!onlySilent) {
      $area.innerHTML = `<div class="text-center text-secondary" style="padding:90px 0 70px 0; font-size:1.3em;" data-i18n="noSelection">${t('noSelection')}</div>`;
    }
    return;
  }

  $area.innerHTML = `
    <h3 style="font-weight:700; font-size:1.35em; margin-bottom:18px;">${task.name}</h3>
    <div class="mb-3">
      <textarea class="form-control mb-1" rows="4" placeholder="${t('taskContentPlaceholder')}" oninput="updatePreview(this.value)"></textarea>
      <div class="form-text">${t('taskContentHint')}</div>
    </div>
    <div class="d-flex align-items-center mb-2 mt-2" style="gap:10px;">
      <div style="font-weight:600; font-size:1.13em;">${t('completedPrompt')}</div>
      <button class="btn btn-primary btn-prompt-add btn-sm ms-auto" onclick="openPromptModal('${cat.id}','${task.id}')">${t('addPrompt')}</button>
    </div>
    <div id="prompts-list"></div>
  `;
  renderPrompts(task.prompts);
}

function renderPrompts(prompts, val = '') {
  const $list = document.getElementById('prompts-list');
  if (!$list) return;
  $list.innerHTML = '';

  prompts.forEach((p, i) => {
    if (selectedPrompt && (selectedPrompt.cat !== currentCat || selectedPrompt.task !== currentTask || selectedPrompt.idx !== i)) {
      return; // 선택된 프롬프트가 있으면 다른 것은 렌더링하지 않음
    }

    const txt = val ? replacePH(p, val) : p;
    const box = document.createElement('div');
    box.className = 'prompt-box position-relative mb-2';

    const isChecked = selectedPrompt && selectedPrompt.cat === currentCat && selectedPrompt.task === currentTask && selectedPrompt.idx === i;
    const lineCount = (txt.match(/\n/g) || []).length + 1;
    const shouldCollapse = lineCount > 3 || txt.length > 150;
    const collapseClass = shouldCollapse ? 'collapsed' : '';
    const toggleButton = shouldCollapse ? `<button class="toggle-btn" onclick="togglePromptText(this)">${t('showMore')}</button>` : '';

    box.innerHTML = `
      <input class="form-check-input prompt-select" type="checkbox" onchange="togglePromptSelect(${i}, this)" ${isChecked ? 'checked' : ''}>
      <div class="prompt-drag-handle">⋮</div>
      <pre class="prompt-text ${collapseClass}">${escapeHtml(txt)}</pre>
      ${toggleButton}
      <div class="prompt-actions">
        <button class="btn btn-secondary btn-sm" onclick="copyPrompt(this)">${t('copy')}</button>
        <button class="btn btn-edit btn-sm" onclick="openPromptModal(currentCat,currentTask,${i})">${t('edit')}</button>
        <button class="btn btn-del btn-sm" onclick="deletePrompt(currentCat,currentTask,${i})">${t('delete')}</button>
      </div>
    `;
    $list.appendChild(box);
    makePromptDraggable(box, currentCat, currentTask, i);
  });

  if ($list.children.length === 0 && selectedPrompt) {
    $list.innerHTML = `<div class="text-secondary" style="padding:12px 4px;">${t('noSelectedPrompt')}</div>`;
  }
}

function updatePreview(v) {
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (task) renderPrompts(task.prompts, v);
}

function togglePromptSelect(idx, cb) {
  selectedPrompt = cb.checked ? { cat: currentCat, task: currentTask, idx } : null;
  const inputVal = document.querySelector('#detail-area textarea')?.value || '';
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (task) renderPrompts(task.prompts, inputVal);
}

/* ---------- 유틸리티 함수 ---------- */
function replacePH(tpl, input) { return tpl.replace(/\[([^\]]*)\]/g, input || ''); }
function escapeHtml(txt) { return txt.replace(/[<>"']/g, m => ({ "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" })[m]); }
function copyPrompt(btn) {
  const promptBox = btn.closest('.prompt-box');
  const promptText = promptBox.querySelector('.prompt-text').textContent;
  navigator.clipboard.writeText(promptText)
    .then(() => { btn.textContent = t('copyComplete'); setTimeout(() => btn.textContent = t('copy'), 900); })
    .catch(() => alert(t('copyFailed')));
}
function togglePromptText(btn) {
  const promptText = btn.parentElement.querySelector('.prompt-text');
  const isCollapsed = promptText.classList.toggle('collapsed');
  btn.innerHTML = isCollapsed ? t('showMore') : t('showLess');
}

/* ---------- 모달 관련 함수 (생성/수정) ---------- */
function openCategoryModal(id) {
  modalMode = id ? 'edit' : 'add';
  modalType = 'cat';
  const cat = id && data.cats.find(c => c.id === id);
  modalRefObj = id ? cat : null;
  showModal(t(id ? 'categoryEdit' : 'categoryAdd'), cat ? cat.name : '', false, '', cat ? cat.emoji : '📁');
}
function openTaskModal(catId, taskId) {
  modalMode = taskId ? 'edit' : 'add';
  modalType = 'task';
  const cat = data.cats.find(c => c.id === catId);
  const task = taskId && cat.tasks.find(t => t.id === taskId);
  modalRefObj = { cat, task };
  showModal(t(taskId ? 'taskEdit' : 'taskAdd'), task ? task.name : '', false);
}
function openPromptModal(catId, taskId, idx) {
  modalMode = idx != null ? 'edit' : 'add';
  modalType = 'prompt';
  const cat = data.cats.find(c => c.id === catId);
  const task = cat.tasks.find(t => t.id === taskId);
  modalRefObj = { cat, task, idx };
  showModal(t(idx != null ? 'promptEdit' : 'promptAdd'), '', true, idx != null ? task.prompts[idx] : '');
  selectedPrompt = null;
}
function showModal(title, val, showTA, taVal = '', emojiVal = '') {
  document.getElementById('modalTitle').textContent = title;
  const $in = document.getElementById('modalInput');
  const $ta = document.getElementById('modalTextarea');
  const $em = document.getElementById('modalEmoji');
  const $row = document.getElementById('emojiInputRow');

  $row.style.display = modalType === 'cat' ? '' : 'none';
  $em.value = emojiVal || '📁';
  $in.style.display = showTA ? 'none' : '';
  $in.value = val || '';
  $ta.style.display = showTA ? '' : 'none';
  $ta.value = taVal || '';

  new bootstrap.Modal(document.getElementById('editModal')).show();
}
function closeModal() {
  bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
}
function saveModal() {
  const $in = document.getElementById('modalInput');
  const $ta = document.getElementById('modalTextarea');
  const $em = document.getElementById('modalEmoji');

  if (modalType === 'cat') {
    const name = $in.value.trim();
    const emoji = ($em.value || '📁').slice(0, 2);
    if (!name) return alert(t('enterCategoryName'));
    if (modalMode === 'add') data.cats.push({ id: 'cat' + Date.now(), name, emoji, tasks: [] });
    else { modalRefObj.name = name; modalRefObj.emoji = emoji; }
  } else if (modalType === 'task') {
    const name = $in.value.trim();
    if (!name) return alert(t('enterTaskName'));
    const cat = modalRefObj.cat;
    if (modalMode === 'add') cat.tasks.push({ id: 'task' + Date.now(), name, prompts: [] });
    else modalRefObj.task.name = name;
  } else if (modalType === 'prompt') {
    const txt = $ta.value.trim();
    if (!txt) return alert(t('enterPromptContent'));
    const task = modalRefObj.task;
    if (modalMode === 'add') task.prompts.push(txt);
    else task.prompts[modalRefObj.idx] = txt;
  }
  saveAndRerender();
  closeModal();
}

/* ---------- 삭제 함수 ---------- */
function deleteCategory(id) {
  if (!confirm(t('confirmDeleteCategory'))) return;
  data.cats = data.cats.filter(c => c.id !== id);
  if (currentCat === id) {
    currentCat = null;
    currentTask = null;
  }
  saveAndRerender();
}
function deleteTask(cid, tid) {
  const cat = data.cats.find(c => c.id === cid);
  if (!cat || !confirm(t('confirmDeleteTask'))) return;
  cat.tasks = cat.tasks.filter(t => t.id !== tid);
  if (currentTask === tid) {
    currentTask = null;
  }
  saveAndRerender();
}
function deletePrompt(cid, tid, idx) {
  const cat = data.cats.find(c => c.id === cid);
  const task = cat && cat.tasks.find(t => t.id === tid);
  if (!task || !confirm(t('confirmDeletePrompt'))) return;
  
  task.prompts.splice(idx, 1);

  if (selectedPrompt && selectedPrompt.cat === cid && selectedPrompt.task === tid) {
    if (selectedPrompt.idx === idx) {
      selectedPrompt = null; // 삭제된 프롬프트가 선택된 것이면 선택 해제
    } else if (selectedPrompt.idx > idx) {
      selectedPrompt.idx--; // 삭제된 프롬프트보다 뒤에 있는 프롬프트였다면 인덱스 감소
    }
  }
  saveAndRerender();
}

/* ---------- 드래그 앤 드롭 함수 (개선됨) ---------- */
function makeCategoryDraggable(catBlock, index) {
    catBlock.draggable = true;
    catBlock.dataset.index = index;

    catBlock.addEventListener('dragstart', e => {
        draggedElement = catBlock;
        dragType = 'category';
        dragContext = { index };
        setTimeout(() => catBlock.classList.add('dragging'), 0);
    });

    catBlock.addEventListener('dragend', () => {
        catBlock.classList.remove('dragging');
        document.querySelectorAll('.cat-block.drag-over').forEach(el => el.classList.remove('drag-over'));
    });

    catBlock.addEventListener('dragover', e => {
        e.preventDefault();
        if (dragType === 'category' && draggedElement !== catBlock) {
            catBlock.classList.add('drag-over');
        }
    });
    
    catBlock.addEventListener('dragleave', () => catBlock.classList.remove('drag-over'));

    catBlock.addEventListener('drop', e => {
        e.preventDefault();
        catBlock.classList.remove('drag-over');
        if (dragType !== 'category') return;

        const fromIndex = dragContext.index;
        const toIndex = index;
        if (fromIndex === toIndex) return;

        const [movedItem] = data.cats.splice(fromIndex, 1);
        data.cats.splice(toIndex, 0, movedItem);
        saveAndRerender();
    });
}

function makeTaskDraggable(taskElement, catId, taskIndex) {
    taskElement.draggable = true;
    taskElement.dataset.catId = catId;
    taskElement.dataset.taskIndex = taskIndex;

    taskElement.addEventListener('dragstart', e => {
        e.stopPropagation();
        draggedElement = taskElement;
        dragType = 'task';
        dragContext = { catId, taskIndex };
        setTimeout(() => taskElement.classList.add('dragging'), 0);
    });

    taskElement.addEventListener('dragend', () => {
        taskElement.classList.remove('dragging');
        document.querySelectorAll('.task-item.drag-over').forEach(el => el.classList.remove('drag-over'));
    });

    taskElement.addEventListener('dragover', e => {
        e.preventDefault();
        if (dragType === 'task' && draggedElement !== taskElement) {
            taskElement.classList.add('drag-over');
        }
    });
    
    taskElement.addEventListener('dragleave', () => taskElement.classList.remove('drag-over'));

    taskElement.addEventListener('drop', e => {
        e.preventDefault();
        e.stopPropagation();
        taskElement.classList.remove('drag-over');
        if (dragType !== 'task') return;

        const { catId: fromCatId, taskIndex: fromIndex } = dragContext;
        const toCatId = catId;
        const toIndex = taskIndex;

        const fromCat = data.cats.find(c => c.id === fromCatId);
        const toCat = data.cats.find(c => c.id === toCatId);
        if (!fromCat || !toCat) return;

        const [movedTask] = fromCat.tasks.splice(fromIndex, 1);
        toCat.tasks.splice(toIndex, 0, movedTask);
        saveAndRerender();
    });
}

function makePromptDraggable(promptElement, catId, taskId, promptIndex) {
    promptElement.draggable = true;
    promptElement.dataset.promptIndex = promptIndex;

    promptElement.addEventListener('dragstart', e => {
        e.stopPropagation();
        draggedElement = promptElement;
        dragType = 'prompt';
        dragContext = { catId, taskId, promptIndex };
        setTimeout(() => promptElement.classList.add('dragging'), 0);
    });

    promptElement.addEventListener('dragend', () => {
        promptElement.classList.remove('dragging');
        document.querySelectorAll('.prompt-box.drag-over').forEach(el => el.classList.remove('drag-over'));
    });

    promptElement.addEventListener('dragover', e => {
        e.preventDefault();
        if (dragType === 'prompt' && draggedElement !== promptElement) {
            promptElement.classList.add('drag-over');
        }
    });

    promptElement.addEventListener('dragleave', () => promptElement.classList.remove('drag-over'));

    promptElement.addEventListener('drop', e => {
        e.preventDefault();
        e.stopPropagation();
        promptElement.classList.remove('drag-over');
        if (dragType !== 'prompt') return;

        const { promptIndex: fromIndex } = dragContext;
        const toIndex = promptIndex;
        
        const cat = data.cats.find(c => c.id === catId);
        const task = cat?.tasks.find(t => t.id === taskId);
        if (!task) return;

        const [movedPrompt] = task.prompts.splice(fromIndex, 1);
        task.prompts.splice(toIndex, 0, movedPrompt);
        saveAndRerender();
    });
}


/* ---------- UI 컨트롤 함수 (글꼴, 가져오기/내보내기) ---------- */
function setFontSize(size) {
  document.body.classList.remove('font-size-small', 'font-size-medium', 'font-size-large', 'font-size-xlarge');
  document.body.classList.add(`font-size-${size}`);
  document.querySelectorAll('.font-size-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.size === size);
  });
  currentFontSize = size;
  localStorage.setItem('fontSizePreference', size);
}

function exportData() {
  try {
    const exportObject = {
      promptUIData: data,
      catToggleState: catToggleState,
      fontSizePreference: currentFontSize,
      exportDate: new Date().toISOString(),
      version: '1.2'
    };
    const jsonString = JSON.stringify(exportObject, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
    const now = new Date();
    const filename = `prompt_library_${now.toISOString().slice(0, 10).replace(/-/g, '')}.json`;
    
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
    showTempMessage(t('exportComplete', filename), 'success');
  } catch (error) {
    showTempMessage(t('exportFailed', error.message), 'error');
  }
}

function toggleImportArea() {
  const area = document.getElementById('importArea');
  area.style.display = area.style.display === 'none' ? 'block' : 'none';
  clearStatus();
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (file) processFile(file);
}

function processFile(file) {
  if (!file.name.toLowerCase().endsWith('.json')) {
    return showStatus(t('jsonOnly'), 'error');
  }
  showStatus(t('fileReading'), 'info');
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const obj = JSON.parse(e.target.result);
      let dataToImport = obj.promptUIData;

      if (!dataToImport || !Array.isArray(dataToImport.cats)) {
         throw new Error(t('invalidFile'));
      }
      
      // 데이터 유효성 검사 및 보정
      dataToImport.cats.forEach((cat, i) => {
        cat.id = cat.id || 'cat' + Date.now() + i;
        cat.tasks = cat.tasks || [];
        cat.tasks.forEach((task, j) => {
          task.id = task.id || 'task' + Date.now() + j;
          task.prompts = task.prompts || [];
        });
      });

      localStorage.setItem('promptUIData', JSON.stringify(dataToImport));
      localStorage.setItem('catToggleState', JSON.stringify(obj.catToggleState || {}));
      localStorage.setItem('fontSizePreference', obj.fontSizePreference || 'medium');
      
      showStatus(t('importComplete', dataToImport.cats.length), 'success');
      setTimeout(() => location.reload(), 1500);
    } catch (err) {
      showStatus(t('importFailed', err.message), 'error');
    }
  };
  reader.onerror = () => showStatus(t('fileReadError'), 'error');
  reader.readAsText(file);
}

function showStatus(message, type = 'info') {
  const statusDiv = document.getElementById('statusMessage');
  statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
}
function clearStatus() {
  document.getElementById('statusMessage').innerHTML = '';
}

function showTempMessage(message, type = 'info', duration = 3000) {
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = `position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; z-index: 9999; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;`;
  if (type === 'success') {
    messageDiv.style.background = '#d4edda'; messageDiv.style.color = '#155724'; messageDiv.style.border = '1px solid #c3e6cb';
  } else if (type === 'error') {
    messageDiv.style.background = '#f8d7da'; messageDiv.style.color = '#721c24'; messageDiv.style.border = '1px solid #f5c6cb';
  }
  messageDiv.textContent = message;
  document.body.appendChild(messageDiv);
  setTimeout(() => {
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateX(100%)';
    setTimeout(() => messageDiv.remove(), 300);
  }, duration);
}

/* ---------- 이벤트 리스너 설정 ---------- */
document.addEventListener('DOMContentLoaded', initialize);

document.addEventListener('click', e => {
  if (e.target.matches('[data-lang]')) {
    e.preventDefault();
    const lang = e.target.dataset.lang;
    localStorage.setItem('ui_lang', lang);
    applyTranslations(lang);
  }
});

const importArea = document.getElementById('importArea');
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  document.body.addEventListener(eventName, e => {
    if (!importArea.contains(e.target)) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, false);
  importArea.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
  }, false);
});
['dragenter', 'dragover'].forEach(eventName => {
  importArea.addEventListener(eventName, () => importArea.classList.add('dragover'), false);
});
['dragleave', 'drop'].forEach(eventName => {
  importArea.addEventListener(eventName, () => importArea.classList.remove('dragover'), false);
});
importArea.addEventListener('drop', e => {
  const files = e.dataTransfer.files;
  if (files.length > 0) processFile(files[0]);
}, false);

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
