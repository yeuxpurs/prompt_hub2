<!DOCTYPE html>
<html lang="ja" data-current-lang="ja" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="appTitle">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #f0f2f5;
      --bg-sidebar: #ffffff;
      --bg-main: #ffffff;
      --bg-card: #f7f9fc;
      --bg-prompt: #f5f8ff;
      --bg-input: #ffffff;
      --bg-hover: #edf2f7;
      --bg-active: #e3ecf7;
      --bg-modal-overlay: rgba(0,0,0,0.4);
      --text-primary: #1a202c;
      --text-secondary: #4a5568;
      --text-muted: #a0aec0;
      --text-accent: #2b6cb0;
      --border-color: #e2e8f0;
      --border-light: #edf2f7;
      --accent: #3182ce;
      --accent-hover: #2b6cb0;
      --accent-light: #ebf4ff;
      --success: #38a169;
      --success-light: #c6f6d5;
      --danger: #e53e3e;
      --danger-light: #fed7d7;
      --warning: #d69e2e;
      --warning-light: #fefcbf;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.1);
      --shadow-glow: 0 0 20px rgba(49,130,206,0.15);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --font-main: 'Noto Sans JP', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'JetBrains Mono', 'Consolas', monospace;
      --sidebar-width: 340px;
      --topbar-height: 48px;
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="dark"] {
      --bg-primary: #0f1117;
      --bg-sidebar: #161822;
      --bg-main: #1a1d2e;
      --bg-card: #1e2235;
      --bg-prompt: #1e2235;
      --bg-input: #252940;
      --bg-hover: #2a2f45;
      --bg-active: #2d3352;
      --bg-modal-overlay: rgba(0,0,0,0.65);
      --text-primary: #e2e8f0;
      --text-secondary: #a0aec0;
      --text-muted: #64708a;
      --text-accent: #63b3ed;
      --border-color: #2d3348;
      --border-light: #252940;
      --accent: #4299e1;
      --accent-hover: #63b3ed;
      --accent-light: rgba(66,153,225,0.15);
      --success: #48bb78;
      --success-light: rgba(72,187,120,0.15);
      --danger: #fc8181;
      --danger-light: rgba(252,129,129,0.15);
      --warning: #f6e05e;
      --warning-light: rgba(246,224,94,0.15);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.25);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.35);
      --shadow-glow: 0 0 20px rgba(66,153,225,0.2);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: var(--font-main);
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
      height: 100vh;
      transition: background var(--transition), color var(--transition);
    }

    /* â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â• */
    .topbar {
      height: var(--topbar-height);
      background: var(--bg-sidebar);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 12px;
      z-index: 100;
      transition: background var(--transition), border-color var(--transition);
    }
    .topbar-title {
      font-weight: 700;
      font-size: 1.05em;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .topbar-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    .icon-btn {
      width: 34px; height: 34px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      background: var(--bg-input);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1em;
      transition: all var(--transition);
    }
    .icon-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--accent);
    }
    .icon-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    /* â•â•â•â•â•â•â• LAYOUT â•â•â•â•â•â•â• */
    .app-layout {
      display: flex;
      height: calc(100vh - var(--topbar-height));
      overflow: hidden;
    }

    /* â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â• */
    .sidebar {
      width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    .sidebar.collapsed {
      width: 0;
      min-width: 0;
      border-right: none;
    }
    .sidebar-header {
      padding: 16px 18px 12px;
      border-bottom: 1px solid var(--border-light);
    }
    .sidebar-search {
      position: relative;
      margin-bottom: 12px;
    }
    .sidebar-search input {
      width: 100%;
      padding: 9px 14px 9px 36px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 0.9em;
      outline: none;
      transition: all var(--transition);
    }
    .sidebar-search input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(49,130,206,0.12);
    }
    .sidebar-search input::placeholder { color: var(--text-muted); }
    .sidebar-search .search-icon {
      position: absolute;
      left: 11px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 0.9em;
      pointer-events: none;
    }
    .sidebar-search .search-clear {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 0.8em;
      cursor: pointer;
      display: none;
      background: none;
      border: none;
      padding: 2px 4px;
    }
    .sidebar-search .search-clear.visible { display: block; }
    .sidebar-tools {
      display: flex;
      gap: 6px;
    }
    .sidebar-tool-btn {
      flex: 1;
      padding: 7px 4px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--bg-input);
      color: var(--text-secondary);
      font-size: 0.78em;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
      transition: all var(--transition);
      white-space: nowrap;
    }
    .sidebar-tool-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
      color: var(--text-primary);
    }
    .sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px 20px;
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }
    .sidebar-body::-webkit-scrollbar { width: 5px; }
    .sidebar-body::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

    /* â•â•â•â•â•â•â• CATEGORY BLOCK â•â•â•â•â•â•â• */
    .cat-block {
      margin-bottom: 6px;
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: all var(--transition);
    }
    .cat-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 10px 10px 6px;
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: all var(--transition);
      user-select: none;
    }
    .cat-header:hover { background: var(--bg-hover); }
    .cat-chevron {
      font-size: 0.65em;
      color: var(--text-muted);
      transition: transform 0.2s;
      width: 16px;
      text-align: center;
      flex-shrink: 0;
    }
    .cat-chevron.open { transform: rotate(90deg); }
    .cat-emoji { font-size: 1.15em; flex-shrink: 0; }
    .cat-title {
      font-size: 0.92em;
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .cat-count {
      font-size: 0.7em;
      color: var(--text-muted);
      background: var(--bg-card);
      padding: 2px 7px;
      border-radius: 10px;
      font-weight: 500;
    }
    .cat-actions {
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity var(--transition);
    }
    .cat-header:hover .cat-actions { opacity: 1; }
    .cat-action-btn {
      width: 26px; height: 26px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8em;
      transition: all var(--transition);
    }
    .cat-action-btn:hover { background: var(--bg-active); color: var(--text-primary); }
    .cat-action-btn.add-btn:hover { color: var(--success); }
    .cat-action-btn.del-btn:hover { color: var(--danger); }

    .task-list { padding: 2px 0 6px 20px; }
    .task-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition);
      margin-bottom: 2px;
      position: relative;
    }
    .task-item:hover { background: var(--bg-hover); }
    .task-item.active {
      background: var(--accent-light);
      color: var(--accent);
      font-weight: 600;
    }
    .task-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 4px;
      bottom: 4px;
      width: 3px;
      background: var(--accent);
      border-radius: 2px;
    }
    .task-drag-handle {
      color: var(--text-muted);
      font-size: 0.85em;
      cursor: grab;
      opacity: 0;
      transition: opacity var(--transition);
      flex-shrink: 0;
    }
    .task-item:hover .task-drag-handle { opacity: 0.6; }
    .task-name {
      flex: 1;
      font-size: 0.88em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .task-prompt-count {
      font-size: 0.65em;
      color: var(--text-muted);
      background: var(--bg-card);
      padding: 1px 6px;
      border-radius: 8px;
      flex-shrink: 0;
    }
    .task-actions {
      display: flex;
      gap: 1px;
      opacity: 0;
      transition: opacity var(--transition);
    }
    .task-item:hover .task-actions { opacity: 1; }
    .task-action-btn {
      width: 24px; height: 24px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      transition: all var(--transition);
    }
    .task-action-btn:hover { background: var(--bg-active); color: var(--text-primary); }
    .task-action-btn.del-btn:hover { color: var(--danger); }

    .add-category-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1.5px dashed var(--border-color);
      border-radius: var(--radius-md);
      background: transparent;
      color: var(--text-muted);
      font-size: 0.85em;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
    }
    .add-category-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-light);
    }

    /* â•â•â•â•â•â•â• MAIN PANE â•â•â•â•â•â•â• */
    .main-pane {
      flex: 1;
      overflow-y: auto;
      padding: 28px 36px 60px;
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }
    .main-pane::-webkit-scrollbar { width: 6px; }
    .main-pane::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      text-align: center;
      gap: 12px;
    }
    .empty-state-icon { font-size: 3em; opacity: 0.5; }
    .empty-state-text { font-size: 1em; line-height: 1.6; }

    .detail-title {
      font-size: 1.4em;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* â•â•â•â•â•â•â• VARIABLES CARD â•â•â•â•â•â•â• */
    .var-card {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: 18px;
      margin-bottom: 24px;
    }
    .var-card-header {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
    }
    .var-card-title {
      font-size: 0.85em;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .var-add-btn {
      margin-left: auto;
      padding: 4px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-input);
      color: var(--text-secondary);
      font-size: 0.78em;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
    }
    .var-add-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-light);
    }
    .var-item {
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 10px;
      transition: all var(--transition);
      cursor: move;
    }
    .var-item:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(49,130,206,0.08);
    }
    .var-item:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(49,130,206,0.1);
    }
    .var-item-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 6px;
    }
    .var-drag-handle {
      color: var(--text-muted);
      cursor: grab;
      font-size: 0.9em;
      user-select: none;
      opacity: 0.4;
      transition: opacity var(--transition);
    }
    .var-item:hover .var-drag-handle { opacity: 0.8; }
    .var-label {
      font-size: 0.85em;
      font-weight: 600;
      color: var(--accent);
    }
    .var-auto-badge {
      font-size: 0.6em;
      color: var(--warning);
      margin-left: 2px;
    }
    .var-item-actions {
      margin-left: auto;
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity var(--transition);
    }
    .var-item:hover .var-item-actions { opacity: 1; }
    .var-action-btn {
      width: 24px; height: 24px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      transition: all var(--transition);
    }
    .var-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .var-textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-light);
      border-radius: 6px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-family: var(--font-main);
      font-size: 0.9em;
      line-height: 1.5;
      resize: vertical;
      min-height: 50px;
      max-height: 300px;
      outline: none;
      transition: all var(--transition);
    }
    .var-textarea:focus {
      border-color: var(--accent);
      background: var(--bg-input);
    }
    .var-textarea::placeholder { color: var(--text-muted); }
    .no-vars-msg {
      color: var(--text-muted);
      font-size: 0.82em;
      text-align: center;
      padding: 8px;
    }

    /* â•â•â•â•â•â•â• PROMPTS SECTION â•â•â•â•â•â•â• */
    .prompts-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .prompts-title {
      font-size: 1em;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .view-toggle {
      display: inline-flex;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
      margin-left: 8px;
    }
    .view-toggle-btn {
      padding: 4px 10px;
      font-size: 0.75em;
      font-weight: 500;
      border: none;
      background: var(--bg-input);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition);
    }
    .view-toggle-btn:not(:last-child) { border-right: 1px solid var(--border-color); }
    .view-toggle-btn:hover { background: var(--bg-hover); }
    .view-toggle-btn.active { background: var(--accent); color: #fff; }
    .prompt-add-btn {
      margin-left: auto;
      padding: 6px 14px;
      border: 1px solid var(--accent);
      border-radius: 6px;
      background: var(--accent);
      color: #fff;
      font-size: 0.82em;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
    }
    .prompt-add-btn:hover { background: var(--accent-hover); box-shadow: var(--shadow-sm); }

    /* â•â•â•â•â•â•â• PROMPT BOX â•â•â•â•â•â•â• */
    .prompt-box {
      background: var(--bg-prompt);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: 18px 18px 14px;
      margin-bottom: 14px;
      position: relative;
      cursor: move;
      transition: all var(--transition);
    }
    .prompt-box:hover {
      border-color: var(--border-color);
      box-shadow: var(--shadow-sm);
    }
    .prompt-top-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .prompt-checkbox {
      width: 18px; height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    .prompt-drag-handle {
      color: var(--text-muted);
      font-size: 0.9em;
      cursor: grab;
      opacity: 0.3;
      transition: opacity var(--transition);
    }
    .prompt-box:hover .prompt-drag-handle { opacity: 0.7; }
    .prompt-number {
      font-size: 0.72em;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--bg-card);
      padding: 2px 8px;
      border-radius: 4px;
    }
    .prompt-fav-btn {
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9em;
      padding: 2px;
      transition: all var(--transition);
    }
    .prompt-fav-btn:hover { transform: scale(1.2); }
    .prompt-fav-btn.active { color: #f6ad55; }
    .prompt-actions-row {
      margin-left: auto;
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity var(--transition);
    }
    .prompt-box:hover .prompt-actions-row { opacity: 1; }
    .prompt-action-btn {
      padding: 4px 8px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.78em;
      transition: all var(--transition);
    }
    .prompt-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .prompt-action-btn.edit-btn:hover { color: var(--accent); }
    .prompt-action-btn.del-btn:hover { color: var(--danger); }

    .prompt-content {
      margin-bottom: 0;
      font-size: 0.93em;
      line-height: 1.65;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: var(--text-primary);
    }
    .prompt-content.collapsed {
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .toggle-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 0.8em;
      padding: 4px 0;
      margin-top: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    .toggle-btn:hover { text-decoration: underline; }

    .prompt-bottom {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px solid var(--border-light);
    }
    .copy-btn {
      padding: 5px 14px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-input);
      color: var(--text-secondary);
      font-size: 0.8em;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
    }
    .copy-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-light);
    }
    .copy-btn.copied {
      border-color: var(--success);
      color: var(--success);
      background: var(--success-light);
    }

    /* â•â•â•â•â•â•â• MARKDOWN RENDERED â•â•â•â•â•â•â• */
    .markdown-rendered {
      padding: 14px 18px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-light);
      line-height: 1.7;
      color: var(--text-primary);
    }
    .markdown-rendered h1, .markdown-rendered h2, .markdown-rendered h3 {
      margin-top: 0.8em; margin-bottom: 0.5em; font-weight: 700;
    }
    .markdown-rendered h1 { font-size: 1.4em; border-bottom: 1px solid var(--border-light); padding-bottom: 0.3em; }
    .markdown-rendered h2 { font-size: 1.2em; }
    .markdown-rendered h3 { font-size: 1.08em; }
    .markdown-rendered p { margin-bottom: 0.8em; }
    .markdown-rendered ul, .markdown-rendered ol { padding-left: 1.5em; margin-bottom: 0.8em; }
    .markdown-rendered li { margin-bottom: 0.3em; }
    .markdown-rendered code {
      background: var(--bg-card); padding: 2px 6px; border-radius: 3px;
      font-family: var(--font-mono); font-size: 0.88em;
    }
    .markdown-rendered pre {
      background: #1e1e2e; color: #cdd6f4; padding: 14px 16px;
      border-radius: var(--radius-sm); overflow-x: auto; margin-bottom: 0.8em;
      font-family: var(--font-mono); font-size: 0.88em;
    }
    .markdown-rendered pre code { background: transparent; color: inherit; padding: 0; }
    .markdown-rendered blockquote {
      border-left: 3px solid var(--accent); padding-left: 14px;
      color: var(--text-secondary); margin: 0.8em 0; font-style: italic;
    }
    .markdown-rendered table { border-collapse: collapse; width: 100%; margin-bottom: 0.8em; }
    .markdown-rendered th, .markdown-rendered td {
      border: 1px solid var(--border-color); padding: 8px 12px; text-align: left;
    }
    .markdown-rendered th { background: var(--bg-card); font-weight: 600; }
    .markdown-rendered a { color: var(--accent); text-decoration: none; }
    .markdown-rendered a:hover { text-decoration: underline; }
    .markdown-rendered hr { border: none; border-top: 1px solid var(--border-light); margin: 1em 0; }

    /* â•â•â•â•â•â•â• DRAGGING â•â•â•â•â•â•â• */
    .dragging { opacity: 0.4; transform: scale(0.97); }
    .drag-over { border-color: var(--accent) !important; background: var(--accent-light) !important; }

    /* â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â• */
    .modal-backdrop { background: var(--bg-modal-overlay); }
    .modal-content {
      background: var(--bg-main);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      border-bottom: 1px solid var(--border-light);
      padding: 18px 24px;
    }
    .modal-title { font-weight: 700; font-size: 1.1em; }
    .modal-body { padding: 20px 24px; }
    .modal-footer {
      border-top: 1px solid var(--border-light);
      padding: 14px 24px;
    }
    .modal .form-control {
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      font-family: var(--font-main);
      transition: all var(--transition);
    }
    .modal .form-control:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(49,130,206,0.12);
    }
    .modal .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      border-radius: var(--radius-sm);
      font-weight: 600;
    }
    .modal .btn-primary:hover { background: var(--accent-hover); }
    .modal .btn-secondary {
      background: var(--bg-card);
      border-color: var(--border-color);
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
    }

    /* â•â•â•â•â•â•â• IMPORT AREA â•â•â•â•â•â•â• */
    .import-area {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      text-align: center;
      margin-top: 10px;
      background: var(--bg-card);
      transition: all var(--transition);
    }
    .import-area.dragover { border-color: var(--accent); background: var(--accent-light); }

    /* â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â• */
    .toast-container {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast-item {
      padding: 12px 20px;
      border-radius: var(--radius-sm);
      font-size: 0.88em;
      font-weight: 500;
      box-shadow: var(--shadow-md);
      animation: toastIn 0.3s ease-out;
      max-width: 380px;
    }
    .toast-item.success { background: var(--success-light); color: var(--success); border: 1px solid var(--success); }
    .toast-item.error { background: var(--danger-light); color: var(--danger); border: 1px solid var(--danger); }
    .toast-item.info { background: var(--accent-light); color: var(--accent); border: 1px solid var(--accent); }
    .toast-item.removing { animation: toastOut 0.3s ease-in forwards; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(40px); } }

    /* â•â•â•â•â•â•â• FONT SIZES â•â•â•â•â•â•â• */
    .font-size-small { font-size: 0.88em !important; }
    .font-size-medium { font-size: 1em !important; }
    .font-size-large { font-size: 1.12em !important; }
    .font-size-xlarge { font-size: 1.24em !important; }

    /* â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â• */
    @media (max-width: 768px) {
      :root { --sidebar-width: 280px; }
      .main-pane { padding: 16px 18px 40px; }
      .sidebar.collapsed + .main-pane { padding: 16px; }
      .topbar { padding: 0 12px; }
    }
    @media (max-width: 480px) {
      :root { --sidebar-width: 100vw; }
      .sidebar:not(.collapsed) + .main-pane { display: none; }
    }

    /* â•â•â•â•â•â•â• LANG DROPDOWN â•â•â•â•â•â•â• */
    .lang-dropdown .dropdown-menu {
      background: var(--bg-main);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      min-width: 140px;
    }
    .lang-dropdown .dropdown-item {
      color: var(--text-secondary);
      font-size: 0.88em;
      padding: 6px 14px;
      transition: all var(--transition);
    }
    .lang-dropdown .dropdown-item:hover { background: var(--bg-hover); color: var(--text-primary); }

    /* Font size popup */
    .fontsize-popup {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 6px;
      background: var(--bg-main);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      padding: 8px;
      display: none;
      z-index: 200;
      gap: 4px;
    }
    .fontsize-popup.show { display: flex; }
    .fs-btn {
      width: 32px; height: 32px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-input);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      transition: all var(--transition);
    }
    .fs-btn:hover { border-color: var(--accent); color: var(--accent); }
    .fs-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* â•â•â•â•â•â•â• HIDDEN â•â•â•â•â•â•â• */
    .file-input-hidden { display: none; }

    /* â•â•â•â•â•â•â• KEYBOARD HINT â•â•â•â•â•â•â• */
    .kbd-hint {
      font-size: 0.65em;
      color: var(--text-muted);
      background: var(--bg-card);
      padding: 1px 5px;
      border-radius: 3px;
      border: 1px solid var(--border-light);
      font-family: var(--font-mono);
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <!-- â•â•â• TOPBAR â•â•â• -->
  <div class="topbar">
    <button class="icon-btn" onclick="toggleSidebar()" title="Toggle Sidebar" id="sidebarToggleBtn">â˜°</button>
    <div class="topbar-title">
      <span>ğŸ“š</span>
      <span data-i18n="appTitle">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª</span>
    </div>
    <div class="topbar-controls">
      <div class="position-relative" id="fontSizeWrapper">
        <button class="icon-btn" onclick="toggleFontSizePopup()" title="Font Size">Aa</button>
        <div class="fontsize-popup" id="fontSizePopup">
          <button class="fs-btn" data-size="small" onclick="setFontSize('small')" style="font-size:0.8em;">A</button>
          <button class="fs-btn active" data-size="medium" onclick="setFontSize('medium')">A</button>
          <button class="fs-btn" data-size="large" onclick="setFontSize('large')" style="font-size:1.15em;">A</button>
          <button class="fs-btn" data-size="xlarge" onclick="setFontSize('xlarge')" style="font-size:1.3em;">A</button>
        </div>
      </div>
      <button class="icon-btn" id="themeToggle" onclick="toggleTheme()" title="Dark/Light Mode">ğŸŒ™</button>
      <div class="lang-dropdown dropdown">
        <button class="icon-btn dropdown-toggle" data-bs-toggle="dropdown" style="width:auto;padding:0 10px;gap:4px;font-size:0.85em;" id="langBtn">
          ğŸŒ <span id="langBtnLabel">æ—¥æœ¬èª</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" data-lang="ja">æ—¥æœ¬èª</a></li>
          <li><a class="dropdown-item" href="#" data-lang="en">English</a></li>
          <li><a class="dropdown-item" href="#" data-lang="zh">ç®€ä½“ä¸­æ–‡</a></li>
          <li><a class="dropdown-item" href="#" data-lang="ko">í•œêµ­ì–´</a></li>
          <li><a class="dropdown-item" href="#" data-lang="fr">FranÃ§ais</a></li>
          <li><a class="dropdown-item" href="#" data-lang="es">EspaÃ±ol</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- â•â•â• MAIN LAYOUT â•â•â• -->
  <div class="app-layout">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-search">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="searchInput" placeholder="Search..." oninput="handleSearch(this.value)">
          <button class="search-clear" id="searchClear" onclick="clearSearch()">âœ•</button>
        </div>
        <div class="sidebar-tools">
          <button class="sidebar-tool-btn" onclick="exportData()" data-i18n="exportBtn">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button class="sidebar-tool-btn" onclick="toggleImportArea()" data-i18n="importBtn">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
        <div id="importArea" class="import-area" style="display:none;">
          <div style="font-size:0.85em; color:var(--text-secondary); margin-bottom:10px;" data-i18n="importInstructions">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã‹ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</div>
          <input type="file" id="fileInput" class="file-input-hidden" accept=".json" onchange="handleFileSelect(event)">
          <button class="sidebar-tool-btn" onclick="document.getElementById('fileInput').click()" style="display:inline-block;width:auto;padding:6px 16px;" data-i18n="fileSelect">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
          <div style="margin-top:8px;">
            <button class="sidebar-tool-btn" onclick="toggleImportArea()" style="display:inline-block;width:auto;padding:4px 12px;font-size:0.75em;" data-i18n="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
          <div id="statusMessage"></div>
        </div>
      </div>
      <div class="sidebar-body" id="sidebarBody">
        <div id="cat-container"></div>
        <button class="add-category-btn" onclick="openCategoryModal()" data-i18n="addCategory">ï¼‹ æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </button>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main-pane" id="mainPane">
      <div id="detail-area">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“</div>
          <div class="empty-state-text" data-i18n="noSelection">
            å·¦å´ã‹ã‚‰é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>ã‚¿ã‚¹ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• TOAST CONTAINER â•â•â• -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- â•â•â• MODAL â•â•â• -->
  <div class="modal" tabindex="-1" id="editModal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="modalTitle" class="modal-title"></h5>
          <button type="button" class="btn-close" onclick="closeModal()" aria-label="Close" style="filter: var(--text-muted);"></button>
        </div>
        <div class="modal-body">
          <div id="emojiInputRow" style="display:none;">
            <label for="modalEmoji" class="form-label mb-1" style="font-size:0.88em;color:var(--text-secondary);" data-i18n="emojiLabel">çµµæ–‡å­—</label>
            <input type="text" id="modalEmoji" class="form-control mb-2" placeholder="ğŸ“" maxlength="2" style="width:80px;">
          </div>
          <input type="text" id="modalInput" class="form-control mb-2" placeholder="">
          <textarea id="modalTextarea" class="form-control" rows="10" style="display:none; resize:both; min-height:200px; font-family:var(--font-mono); font-size:0.92em; line-height:1.6;"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()" data-i18n="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-primary" onclick="saveModal()" data-i18n="saveBtn">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let data;
let currentCat = null, currentTask = null;
let modalMode = null, modalRefObj = null, modalType = null;
let catToggleState;
let currentFontSize;
let selectedPrompt = null;
let currentLang = 'ja';
let draggedElement = null, dragType = null, dragContext = null;
let currentVarState = {};
let currentViewMode = 'raw';
let searchQuery = '';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSLATIONS (full i18n)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const translations = {
  ja: {
    langName:"æ—¥æœ¬èª",appTitle:"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª",fontSizeLabel:"æ–‡å­—ã‚µã‚¤ã‚º:",exportBtn:"ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",importBtn:"ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",importTitle:"ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",importInstructions:"JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã‹ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„",fileSelect:"ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ",cancel:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«",addCategory:"ï¼‹ æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ",noSelection:"å·¦å´ã‹ã‚‰é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>ã‚¿ã‚¹ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚",emojiLabel:"çµµæ–‡å­—",saveBtn:"ä¿å­˜",taskContentPlaceholder:"ã‚¿ã‚¹ã‚¯é–¢é€£ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...",taskContentHint:"â€» å†…å®¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã™ãã«åæ˜ ã•ã‚Œã¾ã™ã€‚<b>Ctrl+V</b>ã§è²¼ã‚Šä»˜ã‘ã‚‚å¯èƒ½ã§ã™ï¼",completedPrompt:"å®Œæˆã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ",addPrompt:"ï¼‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¿½åŠ ",copy:"ğŸ“‹ ã‚³ãƒ”ãƒ¼",edit:"ç·¨é›†",delete:"å‰Šé™¤",copyComplete:"âœ… ã‚³ãƒ”ãƒ¼å®Œäº†",showMore:"ã‚‚ã£ã¨è¦‹ã‚‹ â–¼",showLess:"æŠ˜ã‚ŠãŸãŸã‚€ â–²",noSelectedPrompt:"é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚",categoryAdd:"ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ",categoryEdit:"ã‚«ãƒ†ã‚´ãƒªç·¨é›†",taskAdd:"ã‚¿ã‚¹ã‚¯è¿½åŠ ",taskEdit:"ã‚¿ã‚¹ã‚¯ç·¨é›†",promptAdd:"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¿½åŠ ",promptEdit:"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†",enterCategoryName:"ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼",enterTaskName:"ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼",enterPromptContent:"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼",confirmDeleteCategory:"ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",confirmDeleteTask:"ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",confirmDeletePrompt:"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",copyFailed:"ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼",jsonOnly:"JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚",fileReading:"ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...",invalidFile:"æ­£ã—ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",emptyCategoryData:"ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ç©ºã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§é–‹å§‹ã—ã¾ã™ã€‚",importComplete:"ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼{0}å€‹ã®ã‚«ãƒ†ã‚´ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚",importFailed:"ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: {0}",fileReadError:"ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚",exportComplete:"ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†: {0}",exportFailed:"âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—: {0}",variablesLabel:"å¤‰æ•°å…¥åŠ›",variablePlaceholder:"{0}ã‚’å…¥åŠ›",noVariables:"å¤‰æ•°ãªã—",addVariable:"+ å¤‰æ•°è¿½åŠ ",enterVariableName:"è¿½åŠ ã™ã‚‹å¤‰æ•°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:",enterNewVariableName:"æ–°ã—ã„å¤‰æ•°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:",variableExists:"ã“ã®å¤‰æ•°åã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚",confirmDeleteVariable:"å¤‰æ•°ã€Œ{0}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",deleteFromPromptsWarning:"âš ï¸ ã“ã®å¤‰æ•°ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚å‰Šé™¤ã™ã‚‹ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚",dragToReorder:"ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †åºã‚’å¤‰æ›´",viewRaw:"ğŸ“ åŸæ–‡",viewMarkdown:"ğŸ“„ MD",searchPlaceholder:"æ¤œç´¢..."
  },
  en: {
    langName:"English",appTitle:"Prompt Library",fontSizeLabel:"Font Size:",exportBtn:"ğŸ“¤ Export",importBtn:"ğŸ“¥ Import",importTitle:"ğŸ“¥ Import File",importInstructions:"Drag & drop a JSON file or click to select",fileSelect:"Select File",cancel:"Cancel",addCategory:"+ Add Category",noSelection:"Select an item from the left.<br>Click a task to see prompts.",emojiLabel:"Emoji",saveBtn:"Save",taskContentPlaceholder:"Enter task-related content here...",taskContentHint:"â€» Content entered here will be reflected in prompts below.",completedPrompt:"Completed Prompts",addPrompt:"+ Add Prompt",copy:"ğŸ“‹ Copy",edit:"Edit",delete:"Delete",copyComplete:"âœ… Copied!",showMore:"Show More â–¼",showLess:"Show Less â–²",noSelectedPrompt:"No prompt selected.",categoryAdd:"Add Category",categoryEdit:"Edit Category",taskAdd:"Add Task",taskEdit:"Edit Task",promptAdd:"Add Prompt",promptEdit:"Edit Prompt",enterCategoryName:"Please enter a category name!",enterTaskName:"Please enter a task name!",enterPromptContent:"Please enter the prompt content!",confirmDeleteCategory:"Delete this category?",confirmDeleteTask:"Delete this task?",confirmDeletePrompt:"Delete this prompt?",copyFailed:"Failed to copy!",jsonOnly:"Only JSON files are supported.",fileReading:"Reading file...",invalidFile:"Not a valid prompt library file.",emptyCategoryData:"No category data, starting empty.",importComplete:"Imported {0} categories!",importFailed:"Import failed: {0}",fileReadError:"Error reading file.",exportComplete:"ğŸ“¤ Exported: {0}",exportFailed:"âŒ Export failed: {0}",variablesLabel:"Variables",variablePlaceholder:"Enter {0}",noVariables:"No variables",addVariable:"+ Add Variable",enterVariableName:"Enter variable name:",enterNewVariableName:"Enter new variable name:",variableExists:"Variable already exists.",confirmDeleteVariable:"Delete variable \"{0}\"?",deleteFromPromptsWarning:"âš ï¸ Used in prompts. Deleting removes it from all prompts.",dragToReorder:"Drag to reorder",viewRaw:"ğŸ“ Raw",viewMarkdown:"ğŸ“„ MD",searchPlaceholder:"Search..."
  },
  zh: {
    langName:"ç®€ä½“ä¸­æ–‡",appTitle:"æç¤ºè¯åº“",fontSizeLabel:"å­—ä½“å¤§å°:",exportBtn:"ğŸ“¤ å¯¼å‡º",importBtn:"ğŸ“¥ å¯¼å…¥",importTitle:"ğŸ“¥ å¯¼å…¥æ–‡ä»¶",importInstructions:"æ‹–æ”¾JSONæ–‡ä»¶æˆ–ç‚¹å‡»é€‰æ‹©",fileSelect:"é€‰æ‹©æ–‡ä»¶",cancel:"å–æ¶ˆ",addCategory:"ï¼‹ æ·»åŠ åˆ†ç±»",noSelection:"è¯·ä»å·¦ä¾§é€‰æ‹©é¡¹ç›®ã€‚<br>ç‚¹å‡»ä»»åŠ¡æŸ¥çœ‹è¯¦ç»†æç¤ºã€‚",emojiLabel:"è¡¨æƒ…ç¬¦å·",saveBtn:"ä¿å­˜",taskContentPlaceholder:"åœ¨æ­¤è¾“å…¥ä»»åŠ¡ç›¸å…³å†…å®¹...",taskContentHint:"â€» è¾“å…¥å†…å®¹å°†ç«‹å³åæ˜ åœ¨ä¸‹é¢çš„æç¤ºä¸­ã€‚",completedPrompt:"å®Œæˆçš„æç¤º",addPrompt:"ï¼‹ æ·»åŠ æç¤º",copy:"ğŸ“‹ å¤åˆ¶",edit:"ç¼–è¾‘",delete:"åˆ é™¤",copyComplete:"âœ… å·²å¤åˆ¶",showMore:"å±•å¼€ â–¼",showLess:"æ”¶èµ· â–²",noSelectedPrompt:"æœªé€‰æ‹©ä»»ä½•æç¤ºã€‚",categoryAdd:"æ·»åŠ åˆ†ç±»",categoryEdit:"ç¼–è¾‘åˆ†ç±»",taskAdd:"æ·»åŠ ä»»åŠ¡",taskEdit:"ç¼–è¾‘ä»»åŠ¡",promptAdd:"æ·»åŠ æç¤º",promptEdit:"ç¼–è¾‘æç¤º",enterCategoryName:"è¯·è¾“å…¥åˆ†ç±»åç§°ï¼",enterTaskName:"è¯·è¾“å…¥ä»»åŠ¡åç§°ï¼",enterPromptContent:"è¯·è¾“å…¥æç¤ºå†…å®¹ï¼",confirmDeleteCategory:"ç¡®å®šåˆ é™¤æ­¤åˆ†ç±»ï¼Ÿ",confirmDeleteTask:"ç¡®å®šåˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ",confirmDeletePrompt:"ç¡®å®šåˆ é™¤æ­¤æç¤ºï¼Ÿ",copyFailed:"å¤åˆ¶å¤±è´¥ï¼",jsonOnly:"ä»…æ”¯æŒJSONæ–‡ä»¶ã€‚",fileReading:"æ­£åœ¨è¯»å–...",invalidFile:"ä¸æ˜¯æœ‰æ•ˆçš„æç¤ºåº“æ–‡ä»¶ã€‚",emptyCategoryData:"æœªæ‰¾åˆ°åˆ†ç±»æ•°æ®ã€‚",importComplete:"å¯¼å…¥å®Œæˆï¼{0}ä¸ªåˆ†ç±»ã€‚",importFailed:"å¯¼å…¥å¤±è´¥ï¼š{0}",fileReadError:"è¯»å–æ–‡ä»¶é”™è¯¯ã€‚",exportComplete:"ğŸ“¤ å¯¼å‡ºå®Œæˆ: {0}",exportFailed:"âŒ å¯¼å‡ºå¤±è´¥: {0}",variablesLabel:"è¾“å…¥å˜é‡",variablePlaceholder:"è¾“å…¥{0}",noVariables:"æ— å˜é‡",addVariable:"+ æ·»åŠ å˜é‡",enterVariableName:"è¾“å…¥å˜é‡å:",enterNewVariableName:"è¾“å…¥æ–°å˜é‡å:",variableExists:"å˜é‡åå·²å­˜åœ¨ã€‚",confirmDeleteVariable:"åˆ é™¤å˜é‡ã€Œ{0}ã€ï¼Ÿ",deleteFromPromptsWarning:"âš ï¸ æ­¤å˜é‡åœ¨æç¤ºè¯ä¸­ä½¿ç”¨ã€‚åˆ é™¤åä¹Ÿå°†ä»æ‰€æœ‰æç¤ºè¯ä¸­ç§»é™¤ã€‚",dragToReorder:"æ‹–åŠ¨æ’åº",viewRaw:"ğŸ“ åŸæ–‡",viewMarkdown:"ğŸ“„ MD",searchPlaceholder:"æœç´¢..."
  },
  ko: {
    langName:"í•œêµ­ì–´",appTitle:"í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬",fontSizeLabel:"ê¸€ê¼´:",exportBtn:"ğŸ“¤ ë‚´ë³´ë‚´ê¸°",importBtn:"ğŸ“¥ ê°€ì ¸ì˜¤ê¸°",importTitle:"ğŸ“¥ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°",importInstructions:"JSON íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”",fileSelect:"íŒŒì¼ ì„ íƒ",cancel:"ì·¨ì†Œ",addCategory:"ï¼‹ ì¹´í…Œê³ ë¦¬ ì¶”ê°€",noSelection:"ì™¼ìª½ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.<br>íƒœìŠ¤í¬ë¥¼ í´ë¦­í•˜ë©´ í”„ë¡¬í”„íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.",emojiLabel:"ì´ëª¨ì§€",saveBtn:"ì €ì¥",taskContentPlaceholder:"íƒœìŠ¤í¬ ê´€ë ¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",taskContentHint:"â€» ì…ë ¥ ë‚´ìš©ì´ ì•„ë˜ í”„ë¡¬í”„íŠ¸ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.",completedPrompt:"ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸",addPrompt:"ï¼‹ í”„ë¡¬í”„íŠ¸ ì¶”ê°€",copy:"ğŸ“‹ ë³µì‚¬",edit:"í¸ì§‘",delete:"ì‚­ì œ",copyComplete:"âœ… ë³µì‚¬ ì™„ë£Œ",showMore:"ë” ë³´ê¸° â–¼",showLess:"ì ‘ê¸° â–²",noSelectedPrompt:"ì„ íƒëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.",categoryAdd:"ì¹´í…Œê³ ë¦¬ ì¶”ê°€",categoryEdit:"ì¹´í…Œê³ ë¦¬ í¸ì§‘",taskAdd:"íƒœìŠ¤í¬ ì¶”ê°€",taskEdit:"íƒœìŠ¤í¬ í¸ì§‘",promptAdd:"í”„ë¡¬í”„íŠ¸ ì¶”ê°€",promptEdit:"í”„ë¡¬í”„íŠ¸ í¸ì§‘",enterCategoryName:"ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!",enterTaskName:"íƒœìŠ¤í¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!",enterPromptContent:"í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!",confirmDeleteCategory:"ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",confirmDeleteTask:"íƒœìŠ¤í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",confirmDeletePrompt:"í”„ë¡¬í”„íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",copyFailed:"ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!",jsonOnly:"JSON íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤.",fileReading:"íŒŒì¼ ì½ëŠ” ì¤‘...",invalidFile:"ì˜¬ë°”ë¥¸ í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.",emptyCategoryData:"ì¹´í…Œê³ ë¦¬ ë°ì´í„° ì—†ìŒ. ë¹ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.",importComplete:"ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! {0}ê°œ ì¹´í…Œê³ ë¦¬.",importFailed:"ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {0}",fileReadError:"íŒŒì¼ ì½ê¸° ì˜¤ë¥˜.",exportComplete:"ğŸ“¤ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ: {0}",exportFailed:"âŒ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: {0}",variablesLabel:"ë³€ìˆ˜ ì…ë ¥",variablePlaceholder:"{0}ì„(ë¥¼) ì…ë ¥",noVariables:"ë³€ìˆ˜ ì—†ìŒ",addVariable:"+ ë³€ìˆ˜ ì¶”ê°€",enterVariableName:"ì¶”ê°€í•  ë³€ìˆ˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:",enterNewVariableName:"ìƒˆ ë³€ìˆ˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:",variableExists:"ì´ ë³€ìˆ˜ëª…ì€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.",confirmDeleteVariable:"ë³€ìˆ˜ \"{0}\"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",deleteFromPromptsWarning:"âš ï¸ í”„ë¡¬í”„íŠ¸ì—ì„œ ì‚¬ìš© ì¤‘. ì‚­ì œí•˜ë©´ ëª¨ë“  í”„ë¡¬í”„íŠ¸ì—ì„œë„ ì œê±°ë©ë‹ˆë‹¤.",dragToReorder:"ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½",viewRaw:"ğŸ“ ì›ë³¸",viewMarkdown:"ğŸ“„ MD",searchPlaceholder:"ê²€ìƒ‰..."
  },
  fr: {
    langName:"FranÃ§ais",appTitle:"BibliothÃ¨que de Prompts",fontSizeLabel:"Taille:",exportBtn:"ğŸ“¤ Exporter",importBtn:"ğŸ“¥ Importer",importTitle:"ğŸ“¥ Importer",importInstructions:"Glissez un fichier JSON ou cliquez",fileSelect:"SÃ©lectionner",cancel:"Annuler",addCategory:"+ Ajouter catÃ©gorie",noSelection:"SÃ©lectionnez un Ã©lÃ©ment Ã  gauche.<br>Cliquez pour voir les prompts.",emojiLabel:"Ã‰moji",saveBtn:"Enregistrer",taskContentPlaceholder:"Contenu de la tÃ¢che...",taskContentHint:"â€» ReflÃ©tÃ© immÃ©diatement.",completedPrompt:"Prompts complÃ©tÃ©s",addPrompt:"+ Ajouter prompt",copy:"ğŸ“‹ Copier",edit:"Modifier",delete:"Supprimer",copyComplete:"âœ… CopiÃ© !",showMore:"Plus â–¼",showLess:"Moins â–²",noSelectedPrompt:"Aucun prompt sÃ©lectionnÃ©.",categoryAdd:"Ajouter catÃ©gorie",categoryEdit:"Modifier catÃ©gorie",taskAdd:"Ajouter tÃ¢che",taskEdit:"Modifier tÃ¢che",promptAdd:"Ajouter prompt",promptEdit:"Modifier prompt",enterCategoryName:"Entrez un nom !",enterTaskName:"Entrez un nom !",enterPromptContent:"Entrez le contenu !",confirmDeleteCategory:"Supprimer la catÃ©gorie ?",confirmDeleteTask:"Supprimer la tÃ¢che ?",confirmDeletePrompt:"Supprimer ce prompt ?",copyFailed:"Ã‰chec !",jsonOnly:"JSON uniquement.",fileReading:"Lecture...",invalidFile:"Fichier invalide.",emptyCategoryData:"Aucune donnÃ©e.",importComplete:"ImportÃ© {0} catÃ©gories !",importFailed:"Ã‰chec : {0}",fileReadError:"Erreur de lecture.",exportComplete:"ğŸ“¤ ExportÃ© : {0}",exportFailed:"âŒ Ã‰chec : {0}",variablesLabel:"Variables",variablePlaceholder:"Saisir {0}",noVariables:"Aucune variable",addVariable:"+ Ajouter variable",enterVariableName:"Nom de la variable :",enterNewVariableName:"Nouveau nom :",variableExists:"Existe dÃ©jÃ .",confirmDeleteVariable:"Supprimer Â«{0}Â» ?",deleteFromPromptsWarning:"âš ï¸ UtilisÃ©e dans les prompts.",dragToReorder:"Glisser",viewRaw:"ğŸ“ Brut",viewMarkdown:"ğŸ“„ MD",searchPlaceholder:"Rechercher..."
  },
  es: {
    langName:"EspaÃ±ol",appTitle:"Biblioteca de Prompts",fontSizeLabel:"TamaÃ±o:",exportBtn:"ğŸ“¤ Exportar",importBtn:"ğŸ“¥ Importar",importTitle:"ğŸ“¥ Importar",importInstructions:"Arrastra un JSON o haz clic",fileSelect:"Seleccionar",cancel:"Cancelar",addCategory:"+ AÃ±adir categorÃ­a",noSelection:"Selecciona un elemento.<br>Haz clic para ver prompts.",emojiLabel:"Emoji",saveBtn:"Guardar",taskContentPlaceholder:"Contenido de la tarea...",taskContentHint:"â€» Reflejo inmediato.",completedPrompt:"Prompts completados",addPrompt:"+ AÃ±adir prompt",copy:"ğŸ“‹ Copiar",edit:"Editar",delete:"Eliminar",copyComplete:"âœ… Â¡Copiado!",showMore:"MÃ¡s â–¼",showLess:"Menos â–²",noSelectedPrompt:"NingÃºn prompt seleccionado.",categoryAdd:"AÃ±adir categorÃ­a",categoryEdit:"Editar categorÃ­a",taskAdd:"AÃ±adir tarea",taskEdit:"Editar tarea",promptAdd:"AÃ±adir prompt",promptEdit:"Editar prompt",enterCategoryName:"Â¡Introduce nombre!",enterTaskName:"Â¡Introduce nombre!",enterPromptContent:"Â¡Introduce contenido!",confirmDeleteCategory:"Â¿Eliminar categorÃ­a?",confirmDeleteTask:"Â¿Eliminar tarea?",confirmDeletePrompt:"Â¿Eliminar prompt?",copyFailed:"Â¡Error!",jsonOnly:"Solo JSON.",fileReading:"Leyendo...",invalidFile:"Archivo invÃ¡lido.",emptyCategoryData:"Sin datos.",importComplete:"Â¡Importadas {0} categorÃ­as!",importFailed:"Fallo: {0}",fileReadError:"Error.",exportComplete:"ğŸ“¤ Exportado: {0}",exportFailed:"âŒ Fallo: {0}",variablesLabel:"Variables",variablePlaceholder:"Introducir {0}",noVariables:"Sin variables",addVariable:"+ AÃ±adir variable",enterVariableName:"Nombre:",enterNewVariableName:"Nuevo nombre:",variableExists:"Ya existe.",confirmDeleteVariable:"Â¿Eliminar \"{0}\"?",deleteFromPromptsWarning:"âš ï¸ Usada en prompts.",dragToReorder:"Arrastrar",viewRaw:"ğŸ“ Original",viewMarkdown:"ğŸ“„ MD",searchPlaceholder:"Buscar..."
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   i18n
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyTranslations(lang) {
  const dict = translations[lang] || translations.ja;
  document.documentElement.lang = lang;
  document.documentElement.dataset.currentLang = lang;
  document.getElementById('langBtnLabel').textContent = dict.langName;
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if (dict[key]) el.innerHTML = dict[key];
  });
  const si = document.getElementById('searchInput');
  if (si) si.placeholder = dict.searchPlaceholder || 'Search...';
  currentLang = lang;
}
function t(key, ...args) {
  const dict = translations[currentLang] || translations.ja;
  let text = dict[key] || key;
  args.forEach((arg, i) => { text = text.replace(`{${i}}`, arg); });
  return text;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INITIALIZATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initialize() {
  data = JSON.parse(localStorage.getItem('promptUIData') || 'null') || {
    cats:[
      {id:'cat1',name:'ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ',emoji:'ğŸ“',tasks:[
        {id:'task1',name:'ãƒ¬ãƒãƒ¼ãƒˆè¦ç´„',prompts:[
          'æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã ã‘ã‚’ã¾ã¨ã‚ã¦3è¡Œã§è¦ç´„ã—ã¦ãã ã•ã„ï¼š[ã“ã“ã«å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘]',
          'æ¬¡ã®å†…å®¹ã‚’åŸºã«ã€å°å­¦ç”Ÿã§ã‚‚ç†è§£ã§ãã‚‹ã‚ˆã†ã«ã§ãã‚‹ã ã‘ç°¡å˜ã«èª¬æ˜ã—ã¦ãã ã•ã„ï¼š[ã“ã“ã«å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘]'
        ]},
        {id:'task2',name:'ç›®æ¬¡ãƒ–ãƒ¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒŸãƒ³ã‚°',prompts:[
          "'[ãƒˆãƒ”ãƒƒã‚¯]'ã¨ã„ã†ãƒ†ãƒ¼ãƒã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚å°‚é–€æ€§ã¨å‰µé€ æ€§ãŒéš›ç«‹ã¤ç›®æ¬¡ã‚’5ã¤ã®ç« ã§æ§‹æˆã—ã¦ãã ã•ã„ã€‚"
        ]},
      ]},
      {id:'cat2',name:'ãƒ¡ãƒ¼ãƒ«ä½œæˆ',emoji:'ğŸ“§',tasks:[
        {id:'task3',name:'ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãƒ¡ãƒ¼ãƒ«é€ä¿¡',prompts:[
          'æ¬¡ã®å†…å®¹ã‚’åŸºã«ã€ä¸å¯§ã§å°‚é–€çš„ãªãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚å—ä¿¡è€…ï¼š[åå‰]ã€é€ä¿¡è€…ï¼š[è‡ªåˆ†ã®åå‰]ã€é‡è¦ãªå†…å®¹ï¼š[å†…å®¹]'
        ]}
      ]}
    ]
  };
  catToggleState = JSON.parse(localStorage.getItem('catToggleState') || '{}');
  currentFontSize = localStorage.getItem('fontSizePreference') || 'medium';
  const savedLang = localStorage.getItem('ui_lang') || 'ja';
  const savedTheme = localStorage.getItem('themePreference') || 'light';

  applyTranslations(savedLang);
  setFontSize(currentFontSize);
  applyTheme(savedTheme);
  render();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleTheme() {
  const current = document.documentElement.dataset.theme;
  applyTheme(current === 'dark' ? 'light' : 'dark');
}
function applyTheme(theme) {
  document.documentElement.dataset.theme = theme;
  localStorage.setItem('themePreference', theme);
  document.getElementById('themeToggle').textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR TOGGLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FONT SIZE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleFontSizePopup() {
  document.getElementById('fontSizePopup').classList.toggle('show');
}
function setFontSize(size) {
  document.body.classList.remove('font-size-small','font-size-medium','font-size-large','font-size-xlarge');
  document.body.classList.add(`font-size-${size}`);
  document.querySelectorAll('.fs-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.size === size);
  });
  currentFontSize = size;
  localStorage.setItem('fontSizePreference', size);
  document.getElementById('fontSizePopup').classList.remove('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleSearch(q) {
  searchQuery = q.toLowerCase().trim();
  document.getElementById('searchClear').classList.toggle('visible', q.length > 0);
  render();
}
function clearSearch() {
  document.getElementById('searchInput').value = '';
  searchQuery = '';
  document.getElementById('searchClear').classList.remove('visible');
  render();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA & RENDER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveAndRerender() {
  localStorage.setItem('promptUIData', JSON.stringify(data));
  render();
}

function render() {
  const $cat = document.getElementById('cat-container');
  $cat.innerHTML = '';
  
  data.cats.forEach((cat, index) => {
    // Search filter
    let matchingTasks = cat.tasks;
    if (searchQuery) {
      const catMatch = cat.name.toLowerCase().includes(searchQuery);
      matchingTasks = cat.tasks.filter(task => {
        const taskMatch = task.name.toLowerCase().includes(searchQuery);
        const promptMatch = task.prompts.some(p => p.toLowerCase().includes(searchQuery));
        return catMatch || taskMatch || promptMatch;
      });
      if (!catMatch && matchingTasks.length === 0) return;
    }

    const totalPrompts = cat.tasks.reduce((s, t) => s + t.prompts.length, 0);
    const isOpen = catToggleState[cat.id] !== false;
    
    const blk = document.createElement('div');
    blk.className = 'cat-block';
    blk.dataset.catId = cat.id;
    
    blk.innerHTML = `
      <div class="cat-header" onclick="toggleCat('${cat.id}')">
        <span class="cat-chevron ${isOpen ? 'open' : ''}">â–¶</span>
        <span class="cat-emoji">${cat.emoji || 'ğŸ“'}</span>
        <span class="cat-title">${escapeHtml(cat.name)}</span>
        <span class="cat-count">${totalPrompts}</span>
        <div class="cat-actions" onclick="event.stopPropagation();">
          <button class="cat-action-btn add-btn" onclick="openTaskModal('${cat.id}')" title="${t('taskAdd')}">ï¼‹</button>
          <button class="cat-action-btn" onclick="openCategoryModal('${cat.id}')" title="${t('edit')}">âœï¸</button>
          <button class="cat-action-btn del-btn" onclick="deleteCategory('${cat.id}')" title="${t('delete')}">ğŸ—‘</button>
        </div>
      </div>
      <div class="task-list" id="cat-tasks-${cat.id}" style="display:${isOpen ? '' : 'none'}"></div>
    `;
    $cat.appendChild(blk);
    makeCategoryDraggable(blk, index);

    const $tl = blk.querySelector('.task-list');
    matchingTasks.forEach((task, taskIndex) => {
      const origIdx = cat.tasks.indexOf(task);
      const isActive = currentCat === cat.id && currentTask === task.id;
      const $t = document.createElement('div');
      $t.className = `task-item${isActive ? ' active' : ''}`;
      $t.innerHTML = `
        <span class="task-drag-handle">â‹®</span>
        <span class="task-name" onclick="showDetail('${cat.id}','${task.id}')">${escapeHtml(task.name)}</span>
        <span class="task-prompt-count">${task.prompts.length}</span>
        <div class="task-actions" onclick="event.stopPropagation();">
          <button class="task-action-btn" onclick="openTaskModal('${cat.id}','${task.id}')" title="${t('edit')}">âœï¸</button>
          <button class="task-action-btn del-btn" onclick="deleteTask('${cat.id}','${task.id}')" title="${t('delete')}">ğŸ—‘</button>
        </div>
      `;
      $tl.appendChild($t);
      makeTaskDraggable($t, cat.id, origIdx);
    });
  });
  
  showDetail(currentCat, currentTask, true);
}

function toggleCat(id) {
  const el = document.getElementById('cat-tasks-' + id);
  if (!el) return;
  const isNowOpen = el.style.display === 'none';
  el.style.display = isNowOpen ? '' : 'none';
  catToggleState[id] = isNowOpen;
  localStorage.setItem('catToggleState', JSON.stringify(catToggleState));
  // Update chevron
  const blk = el.closest('.cat-block');
  const chevron = blk.querySelector('.cat-chevron');
  if (chevron) chevron.classList.toggle('open', isNowOpen);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL AREA
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showDetail(catId, taskId, onlySilent) {
  if (currentCat !== catId || currentTask !== taskId) {
    currentVarState = {};
  }
  currentCat = catId;
  currentTask = taskId;
  selectedPrompt = null;

  const $area = document.getElementById('detail-area');
  const cat = data.cats.find(c => c.id === catId);
  const task = cat && cat.tasks.find(t => t.id === taskId);

  if (!cat || !task) {
    if (!onlySilent) {
      $area.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div class="empty-state-text" data-i18n="noSelection">${t('noSelection')}</div></div>`;
    }
    return;
  }

  // Highlight active task
  document.querySelectorAll('.task-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.task-item').forEach(el => {
    const nameEl = el.querySelector('.task-name');
    if (nameEl && nameEl.getAttribute('onclick')?.includes(taskId)) {
      el.classList.add('active');
    }
  });

  if (!task.variables) task.variables = [];

  // Extract variables from prompts
  const autoDetectedVars = new Set();
  task.prompts.forEach(p => {
    const matches = p.match(/\[([^\[\]]+)\]/g);
    if (matches) matches.forEach(m => {
      const v = m.replace(/[\[\]]/g, '').trim();
      if (v) autoDetectedVars.add(v);
    });
  });

  if (!task.variableOrder) task.variableOrder = [];
  const allVarsSet = new Set([...task.variables.filter(v => v && v.trim()), ...autoDetectedVars]);
  const validOrder = task.variableOrder.filter(v => allVarsSet.has(v));
  allVarsSet.forEach(v => { if (!validOrder.includes(v)) validOrder.push(v); });
  task.variableOrder = validOrder;
  const allVars = task.variableOrder;

  // Build variables HTML
  let varsHtml = '';
  if (allVars.length > 0) {
    allVars.forEach((v, idx) => {
      const isAuto = autoDetectedVars.has(v);
      const val = currentVarState[v] || '';
      varsHtml += `
        <div class="var-item" data-var="${escapeHtml(v)}" data-idx="${idx}" draggable="true">
          <div class="var-item-header">
            <span class="var-drag-handle" title="${t('dragToReorder')}">â‹®â‹®</span>
            <span class="var-label">[${escapeHtml(v)}]</span>
            ${isAuto ? '<span class="var-auto-badge" title="Auto-detected">âš¡</span>' : ''}
            <div class="var-item-actions">
              <button class="var-action-btn" onclick="editVariable('${escapeHtml(v)}')" title="${t('edit')}">âœï¸</button>
              <button class="var-action-btn" onclick="deleteVariable('${escapeHtml(v)}')" title="${t('delete')}">ğŸ—‘</button>
            </div>
          </div>
          <textarea class="var-textarea" rows="2" placeholder="${t('variablePlaceholder', v)}" 
                    oninput="updateVariable('${escapeHtml(v)}', this.value); autoResizeTextarea(this);">${escapeHtml(val)}</textarea>
        </div>`;
    });
  } else {
    varsHtml = `<div class="no-vars-msg">${t('noVariables')}</div>`;
  }

  $area.innerHTML = `
    <div class="detail-title">${escapeHtml(task.name)}</div>
    
    <div class="var-card">
      <div class="var-card-header">
        <div class="var-card-title">ğŸ”¤ ${t('variablesLabel')}</div>
        <button class="var-add-btn" onclick="openAddVariableModal()">${t('addVariable')}</button>
      </div>
      <div id="variables-container">${varsHtml}</div>
    </div>

    <div class="prompts-header">
      <div class="prompts-title">${t('completedPrompt')}</div>
      <div class="view-toggle">
        <button class="view-toggle-btn ${currentViewMode === 'raw' ? 'active' : ''}" onclick="setViewMode('raw')">${t('viewRaw')}</button>
        <button class="view-toggle-btn ${currentViewMode === 'markdown' ? 'active' : ''}" onclick="setViewMode('markdown')">${t('viewMarkdown')}</button>
      </div>
      <button class="prompt-add-btn" onclick="openPromptModal('${cat.id}','${task.id}')">${t('addPrompt')}</button>
    </div>
    <div id="prompts-list"></div>
  `;

  renderPrompts(task.prompts);
  initVariableDragAndDrop();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEW MODE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setViewMode(mode) {
  currentViewMode = mode;
  document.querySelectorAll('.view-toggle-btn').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.trim() === (mode === 'raw' ? t('viewRaw') : t('viewMarkdown')));
  });
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (task) renderPrompts(task.prompts);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROMPT RENDERING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPrompts(prompts) {
  const $list = document.getElementById('prompts-list');
  if (!$list) return;
  $list.innerHTML = '';

  prompts.forEach((p, i) => {
    if (selectedPrompt && (selectedPrompt.cat !== currentCat || selectedPrompt.task !== currentTask || selectedPrompt.idx !== i)) return;

    const txt = replacePH(p, currentVarState);
    const box = document.createElement('div');
    box.className = 'prompt-box';

    const isChecked = selectedPrompt && selectedPrompt.idx === i;
    const isFav = p._fav; // future feature placeholder

    let contentHtml;
    if (currentViewMode === 'markdown') {
      contentHtml = `<div class="markdown-rendered">${marked.parse(txt)}</div>`;
    } else {
      const lines = (txt.match(/\n/g) || []).length + 1;
      const shouldCollapse = lines > 6 || txt.length > 400;
      contentHtml = `
        <pre class="prompt-content ${shouldCollapse ? 'collapsed' : ''}">${escapeHtml(txt)}</pre>
        ${shouldCollapse ? `<button class="toggle-btn" onclick="togglePromptText(this)">${t('showMore')}</button>` : ''}
      `;
    }

    box.innerHTML = `
      <div class="prompt-top-row">
        <input class="prompt-checkbox" type="checkbox" onchange="togglePromptSelect(${i}, this)" ${isChecked ? 'checked' : ''}>
        <span class="prompt-drag-handle">â‹®â‹®</span>
        <span class="prompt-number">#${i + 1}</span>
        <div class="prompt-actions-row">
          <button class="prompt-action-btn edit-btn" onclick="openPromptModal(currentCat,currentTask,${i})">${t('edit')}</button>
          <button class="prompt-action-btn del-btn" onclick="deletePrompt(currentCat,currentTask,${i})">${t('delete')}</button>
        </div>
      </div>
      ${contentHtml}
      <div class="prompt-bottom">
        <button class="copy-btn" onclick="copyPrompt(this)" data-raw-text="${escapeHtml(txt).replace(/"/g, '&quot;')}">${t('copy')}</button>
      </div>
    `;
    $list.appendChild(box);
    makePromptDraggable(box, currentCat, currentTask, i);
  });

  if ($list.children.length === 0 && selectedPrompt) {
    $list.innerHTML = `<div style="color:var(--text-muted);padding:12px;">${t('noSelectedPrompt')}</div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLE MANAGEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openAddVariableModal() {
  const name = prompt(t('enterVariableName'));
  if (name && name.trim()) addVariable(name.trim());
}

function addVariable(varName) {
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (!task) return;
  if (!task.variables) task.variables = [];
  
  const autoVars = new Set();
  task.prompts.forEach(p => {
    const m = p.match(/\[([^\[\]]+)\]/g);
    if (m) m.forEach(x => { const v = x.replace(/[\[\]]/g, '').trim(); if (v) autoVars.add(v); });
  });
  if (task.variables.includes(varName) || autoVars.has(varName)) { alert(t('variableExists')); return; }
  task.variables.push(varName);
  currentVarState[varName] = '';
  localStorage.setItem('promptUIData', JSON.stringify(data));
  showDetail(currentCat, currentTask);
}

function deleteVariable(varName) {
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (!task) return;
  const autoVars = new Set();
  task.prompts.forEach(p => {
    const m = p.match(/\[([^\[\]]+)\]/g);
    if (m) m.forEach(x => { const v = x.replace(/[\[\]]/g, '').trim(); if (v) autoVars.add(v); });
  });
  const isAuto = autoVars.has(varName);
  let msg = t('confirmDeleteVariable', varName);
  if (isAuto) msg += '\n\n' + t('deleteFromPromptsWarning');
  if (!confirm(msg)) return;
  if (task.variables) task.variables = task.variables.filter(v => v !== varName);
  if (isAuto) task.prompts = task.prompts.map(p => p.replace(new RegExp(`\\[${escapeRegex(varName)}\\]`, 'g'), ''));
  delete currentVarState[varName];
  localStorage.setItem('promptUIData', JSON.stringify(data));
  showDetail(currentCat, currentTask);
}

function editVariable(oldName) {
  const newName = prompt(t('enterNewVariableName'), oldName);
  if (!newName || newName.trim() === '' || newName.trim() === oldName) return;
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (!task) return;
  const trimmed = newName.trim();
  const autoVars = new Set();
  task.prompts.forEach(p => {
    const m = p.match(/\[([^\[\]]+)\]/g);
    if (m) m.forEach(x => { const v = x.replace(/[\[\]]/g, '').trim(); if (v) autoVars.add(v); });
  });
  if ((task.variables && task.variables.includes(trimmed)) || (autoVars.has(trimmed) && trimmed !== oldName)) { alert(t('variableExists')); return; }
  if (task.variables) {
    const idx = task.variables.indexOf(oldName);
    if (idx !== -1) task.variables[idx] = trimmed;
    else task.variables.push(trimmed);
  }
  task.prompts = task.prompts.map(p => p.replace(new RegExp(`\\[${escapeRegex(oldName)}\\]`, 'g'), `[${trimmed}]`));
  if (currentVarState[oldName] !== undefined) { currentVarState[trimmed] = currentVarState[oldName]; delete currentVarState[oldName]; }
  localStorage.setItem('promptUIData', JSON.stringify(data));
  showDetail(currentCat, currentTask);
}

function updateVariable(key, value) {
  currentVarState[key] = value;
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (task) renderPrompts(task.prompts);
}

function autoResizeTextarea(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 300) + 'px';
}

function initVariableDragAndDrop() {
  const container = document.getElementById('variables-container');
  if (!container) return;
  const items = container.querySelectorAll('.var-item');
  let draggedItem = null;
  items.forEach(item => {
    item.addEventListener('dragstart', e => { draggedItem = item; item.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
    item.addEventListener('dragend', () => { item.classList.remove('dragging'); items.forEach(i => i.classList.remove('drag-over')); draggedItem = null; });
    item.addEventListener('dragover', e => { e.preventDefault(); if (item !== draggedItem) item.classList.add('drag-over'); });
    item.addEventListener('dragleave', () => item.classList.remove('drag-over'));
    item.addEventListener('drop', e => {
      e.preventDefault(); item.classList.remove('drag-over');
      if (!draggedItem || draggedItem === item) return;
      reorderVariable(draggedItem.dataset.var, item.dataset.var);
    });
  });
}

function reorderVariable(fromVar, toVar) {
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (!task || !task.variableOrder) return;
  const fi = task.variableOrder.indexOf(fromVar), ti = task.variableOrder.indexOf(toVar);
  if (fi === -1 || ti === -1) return;
  task.variableOrder.splice(fi, 1);
  task.variableOrder.splice(ti, 0, fromVar);
  localStorage.setItem('promptUIData', JSON.stringify(data));
  showDetail(currentCat, currentTask);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOGGLES & UTILS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function togglePromptSelect(idx, cb) {
  selectedPrompt = cb.checked ? { cat: currentCat, task: currentTask, idx } : null;
  const cat = data.cats.find(c => c.id === currentCat);
  const task = cat && cat.tasks.find(t => t.id === currentTask);
  if (task) renderPrompts(task.prompts);
}

function replacePH(tpl, vs) {
  return tpl.replace(/\[(.*?)\]/g, (m, p1) => (vs[p1] !== undefined && vs[p1] !== '') ? vs[p1] : m);
}
function escapeHtml(txt) { return txt.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
function unescapeHtml(txt) { return txt.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&amp;/g,'&'); }
function escapeRegex(str) { return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

function copyPrompt(btn) {
  let text = btn.dataset.rawText ? unescapeHtml(btn.dataset.rawText) : '';
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = t('copyComplete');
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = t('copy'); btn.classList.remove('copied'); }, 1200);
  }).catch(() => toast(t('copyFailed'), 'error'));
}

function togglePromptText(btn) {
  const box = btn.closest('.prompt-box');
  const pre = box.querySelector('.prompt-content');
  if (!pre) return;
  const collapsed = pre.classList.toggle('collapsed');
  btn.innerHTML = collapsed ? t('showMore') : t('showLess');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openCategoryModal(id) {
  modalMode = id ? 'edit' : 'add'; modalType = 'cat';
  const cat = id && data.cats.find(c => c.id === id);
  modalRefObj = id ? cat : null;
  showModal(t(id ? 'categoryEdit' : 'categoryAdd'), cat ? cat.name : '', false, '', cat ? cat.emoji : 'ğŸ“');
}
function openTaskModal(catId, taskId) {
  modalMode = taskId ? 'edit' : 'add'; modalType = 'task';
  const cat = data.cats.find(c => c.id === catId);
  const task = taskId && cat.tasks.find(t => t.id === taskId);
  modalRefObj = { cat, task };
  showModal(t(taskId ? 'taskEdit' : 'taskAdd'), task ? task.name : '', false);
}
function openPromptModal(catId, taskId, idx) {
  modalMode = idx != null ? 'edit' : 'add'; modalType = 'prompt';
  const cat = data.cats.find(c => c.id === catId);
  const task = cat.tasks.find(t => t.id === taskId);
  modalRefObj = { cat, task, idx };
  showModal(t(idx != null ? 'promptEdit' : 'promptAdd'), '', true, idx != null ? task.prompts[idx] : '');
  selectedPrompt = null;
}
function showModal(title, val, showTA, taVal = '', emojiVal = '') {
  document.getElementById('modalTitle').textContent = title;
  const $in = document.getElementById('modalInput'), $ta = document.getElementById('modalTextarea');
  const $em = document.getElementById('modalEmoji'), $row = document.getElementById('emojiInputRow');
  $row.style.display = modalType === 'cat' ? '' : 'none';
  $em.value = emojiVal || 'ğŸ“';
  $in.style.display = showTA ? 'none' : ''; $in.value = val || '';
  $ta.style.display = showTA ? '' : 'none'; $ta.value = taVal || '';
  new bootstrap.Modal(document.getElementById('editModal')).show();
  setTimeout(() => (showTA ? $ta : $in).focus(), 300);
}
function closeModal() { bootstrap.Modal.getInstance(document.getElementById('editModal'))?.hide(); }
function saveModal() {
  const $in = document.getElementById('modalInput'), $ta = document.getElementById('modalTextarea'), $em = document.getElementById('modalEmoji');
  if (modalType === 'cat') {
    const name = $in.value.trim(), emoji = ($em.value || 'ğŸ“').slice(0, 2);
    if (!name) return alert(t('enterCategoryName'));
    if (modalMode === 'add') data.cats.push({ id: 'cat' + Date.now(), name, emoji, tasks: [] });
    else { modalRefObj.name = name; modalRefObj.emoji = emoji; }
  } else if (modalType === 'task') {
    const name = $in.value.trim();
    if (!name) return alert(t('enterTaskName'));
    if (modalMode === 'add') modalRefObj.cat.tasks.push({ id: 'task' + Date.now(), name, prompts: [] });
    else modalRefObj.task.name = name;
  } else if (modalType === 'prompt') {
    const txt = $ta.value.trim();
    if (!txt) return alert(t('enterPromptContent'));
    if (modalMode === 'add') modalRefObj.task.prompts.push(txt);
    else modalRefObj.task.prompts[modalRefObj.idx] = txt;
  }
  saveAndRerender(); closeModal();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DELETE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function deleteCategory(id) {
  if (!confirm(t('confirmDeleteCategory'))) return;
  data.cats = data.cats.filter(c => c.id !== id);
  if (currentCat === id) { currentCat = null; currentTask = null; }
  saveAndRerender();
}
function deleteTask(cid, tid) {
  const cat = data.cats.find(c => c.id === cid);
  if (!cat || !confirm(t('confirmDeleteTask'))) return;
  cat.tasks = cat.tasks.filter(t => t.id !== tid);
  if (currentTask === tid) currentTask = null;
  saveAndRerender();
}
function deletePrompt(cid, tid, idx) {
  const cat = data.cats.find(c => c.id === cid);
  const task = cat && cat.tasks.find(t => t.id === tid);
  if (!task || !confirm(t('confirmDeletePrompt'))) return;
  task.prompts.splice(idx, 1);
  if (selectedPrompt && selectedPrompt.cat === cid && selectedPrompt.task === tid) {
    if (selectedPrompt.idx === idx) selectedPrompt = null;
    else if (selectedPrompt.idx > idx) selectedPrompt.idx--;
  }
  saveAndRerender();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAG AND DROP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function makeCategoryDraggable(el, index) {
  el.draggable = true; el.dataset.index = index;
  el.addEventListener('dragstart', e => { draggedElement = el; dragType = 'category'; dragContext = { index }; setTimeout(() => el.classList.add('dragging'), 0); });
  el.addEventListener('dragend', () => { el.classList.remove('dragging'); document.querySelectorAll('.cat-block.drag-over').forEach(x => x.classList.remove('drag-over')); });
  el.addEventListener('dragover', e => { e.preventDefault(); if (dragType === 'category' && draggedElement !== el) el.classList.add('drag-over'); });
  el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
  el.addEventListener('drop', e => { e.preventDefault(); el.classList.remove('drag-over'); if (dragType !== 'category') return; const fi = dragContext.index; if (fi === index) return; const [m] = data.cats.splice(fi, 1); data.cats.splice(index, 0, m); saveAndRerender(); });
}
function makeTaskDraggable(el, catId, taskIndex) {
  el.draggable = true;
  el.addEventListener('dragstart', e => { e.stopPropagation(); draggedElement = el; dragType = 'task'; dragContext = { catId, taskIndex }; setTimeout(() => el.classList.add('dragging'), 0); });
  el.addEventListener('dragend', () => { el.classList.remove('dragging'); document.querySelectorAll('.task-item.drag-over').forEach(x => x.classList.remove('drag-over')); });
  el.addEventListener('dragover', e => { e.preventDefault(); if (dragType === 'task' && draggedElement !== el) el.classList.add('drag-over'); });
  el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
  el.addEventListener('drop', e => { e.preventDefault(); e.stopPropagation(); el.classList.remove('drag-over'); if (dragType !== 'task') return; const { catId: fc, taskIndex: fi } = dragContext; const fromCat = data.cats.find(c => c.id === fc); const toCat = data.cats.find(c => c.id === catId); if (!fromCat || !toCat) return; const [m] = fromCat.tasks.splice(fi, 1); toCat.tasks.splice(taskIndex, 0, m); saveAndRerender(); });
}
function makePromptDraggable(el, catId, taskId, promptIndex) {
  el.draggable = true;
  el.addEventListener('dragstart', e => { e.stopPropagation(); draggedElement = el; dragType = 'prompt'; dragContext = { catId, taskId, promptIndex }; setTimeout(() => el.classList.add('dragging'), 0); });
  el.addEventListener('dragend', () => { el.classList.remove('dragging'); document.querySelectorAll('.prompt-box.drag-over').forEach(x => x.classList.remove('drag-over')); });
  el.addEventListener('dragover', e => { e.preventDefault(); if (dragType === 'prompt' && draggedElement !== el) el.classList.add('drag-over'); });
  el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
  el.addEventListener('drop', e => { e.preventDefault(); e.stopPropagation(); el.classList.remove('drag-over'); if (dragType !== 'prompt') return; const fi = dragContext.promptIndex; const cat = data.cats.find(c => c.id === catId); const task = cat?.tasks.find(t => t.id === taskId); if (!task) return; const [m] = task.prompts.splice(fi, 1); task.prompts.splice(promptIndex, 0, m); saveAndRerender(); });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT / IMPORT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportData() {
  try {
    const obj = { promptUIData: data, catToggleState, fontSizePreference: currentFontSize, exportDate: new Date().toISOString(), version: '2.0' };
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json;charset=utf-8' });
    const fn = `prompt_library_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.json`;
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fn;
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
    toast(t('exportComplete', fn), 'success');
  } catch (e) { toast(t('exportFailed', e.message), 'error'); }
}
function toggleImportArea() {
  const a = document.getElementById('importArea');
  a.style.display = a.style.display === 'none' ? 'block' : 'none';
}
function handleFileSelect(e) { const f = e.target.files[0]; if (f) processFile(f); }
function processFile(file) {
  if (!file.name.toLowerCase().endsWith('.json')) return toast(t('jsonOnly'), 'error');
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const obj = JSON.parse(e.target.result);
      let d = obj.promptUIData;
      if (!d || !Array.isArray(d.cats)) throw new Error(t('invalidFile'));
      d.cats.forEach((cat, i) => { cat.id = cat.id || 'cat' + Date.now() + i; cat.tasks = cat.tasks || []; cat.tasks.forEach((task, j) => { task.id = task.id || 'task' + Date.now() + j; task.prompts = task.prompts || []; }); });
      localStorage.setItem('promptUIData', JSON.stringify(d));
      localStorage.setItem('catToggleState', JSON.stringify(obj.catToggleState || {}));
      localStorage.setItem('fontSizePreference', obj.fontSizePreference || 'medium');
      toast(t('importComplete', d.cats.length), 'success');
      setTimeout(() => location.reload(), 1200);
    } catch (err) { toast(t('importFailed', err.message), 'error'); }
  };
  reader.onerror = () => toast(t('fileReadError'), 'error');
  reader.readAsText(file);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(msg, type = 'info', dur = 3000) {
  const c = document.getElementById('toastContainer');
  const d = document.createElement('div');
  d.className = `toast-item ${type}`;
  d.textContent = msg;
  c.appendChild(d);
  setTimeout(() => { d.classList.add('removing'); setTimeout(() => d.remove(), 300); }, dur);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EVENT LISTENERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', initialize);

document.addEventListener('click', e => {
  if (e.target.matches('[data-lang]')) {
    e.preventDefault();
    const lang = e.target.dataset.lang;
    localStorage.setItem('ui_lang', lang);
    applyTranslations(lang);
    // Re-render detail area with new lang
    if (currentCat && currentTask) showDetail(currentCat, currentTask);
  }
  // Close font size popup when clicking outside
  if (!document.getElementById('fontSizeWrapper').contains(e.target)) {
    document.getElementById('fontSizePopup').classList.remove('show');
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
    if (modal) modal.hide();
  }
  // Ctrl+K for search focus
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
});

// Modal enter key to save
document.getElementById('editModal').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey && modalType !== 'prompt') {
    e.preventDefault();
    saveModal();
  }
});

// Import drag and drop
const importArea = document.getElementById('importArea');
['dragenter','dragover','dragleave','drop'].forEach(ev => {
  importArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }, false);
});
['dragenter','dragover'].forEach(ev => { importArea.addEventListener(ev, () => importArea.classList.add('dragover')); });
['dragleave','drop'].forEach(ev => { importArea.addEventListener(ev, () => importArea.classList.remove('dragover')); });
importArea.addEventListener('drop', e => { if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0]); });

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
